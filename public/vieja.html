<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>De Belingo Con Ángel</title>
    <link rel="icon" type="image/jpeg" href="https://debelingoconangel.web.app/fotos/dbca.jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
            background-color: #f4f4f4;
            color: #333;
        }
        .header {
            background: linear-gradient(90deg, #007BFF, #0056b3, #007BFF);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            animation: colorChange 2s infinite alternate, zoomInOut 5s infinite alternate;
            font-family: 'Pacifico', cursive;
        }
        @keyframes colorChange {
            0% { background: linear-gradient(90deg, #007BFF, #0056b3, #007BFF); }
            50% { background: linear-gradient(90deg, #0056b3, #007BFF, #0056b3); }
            100% { background: linear-gradient(90deg, #007BFF, #0056b3, #007BFF); }
        }
        @keyframes zoomInOut {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .complete-events-container {
            background-color: #333;
            color: white;
            padding: 20px;
            text-align: left;
            margin-top: 20px;
            box-sizing: border-box;
            border-radius: 10px !important;
            overflow: hidden !important;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .complete-events-container h2 {
            color: white;
            text-decoration: underline;
            font-style: italic;
            margin-bottom: 20px;
        }
        .complete-events-container h3 {
    font-size: 1.3em !important;  /* Aumentar tamaño en ~10% (ej: de 1.2em a 1.3em) */
    border-left: 4px solid #FFD700;  /* Línea amarilla izquierda */
    border-right: 4px solid #FFD700;  /* Línea amarilla derecha */
    padding: 8px 15px !important;  /* Espaciado para las líneas */
    margin: 15px 0 !important;
    background: linear-gradient(90deg, transparent 0%, rgba(255,215,0,0.1) 50%, transparent 100%);
}

        .complete-events-container p {
            margin: 5px 0;
            color: white;
        }
        .ai-form-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .ai-form-container input, .ai-form-container textarea {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .ai-form-container button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .ai-form-container button:hover {
            background-color: #45a049;
        }
        .ai-response {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9e9e9;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .stats-container {
            background-color: #333;
            color: white;
            padding: 20px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .stats-container canvas {
            width: 100%;
            max-width: 100%;
            margin: 20px 0;
        }
        .last-update {
            color: green;
            font-weight: bold;
            text-decoration: underline;
            text-align: center;
            margin-top: 20px;
        }
        .text-translation {
            background-color: #fff;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .text-translation table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed;
            word-wrap: break-word;
            margin: 0 auto;
            transition: opacity 0.5s ease-in-out;
        }
        .text-translation th, .text-translation td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            word-wrap: break-word;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .text-translation th {
            background-color: #f2f2f2;
        }
        .text-translation table tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .text-translation table tbody tr:nth-child(even) {
            background-color: #ffffff;
        }
      
       /* Eliminar cualquier regla previa para .orquesta-column y .actuaciones-column */

/* Fuerza los anchos con selectores atómicos */
.text-translation table.monthly-table > thead > tr > th.orquesta-column,
.text-translation table.monthly-table > tbody > tr > td.orquesta-column {
    width: 70% !important;
    min-width: 70% !important;
    max-width: 70% !important;
    display: table-cell !important;
    padding: 11px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    box-sizing: border-box;
}

.text-translation table.monthly-table > thead > tr > th.actuaciones-column,
.text-translation table.monthly-table > tbody > tr > td.actuaciones-column {
    width: 30% !important;
    min-width: 30% !important;
    max-width: 30% !important;
    display: table-cell !important;
    padding: 11px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
    color: #2c3e50;
    box-sizing: border-box;
}

/* Nuclear: Anular cualquier width heredado */
.text-translation table.monthly-table td,
.text-translation table.monthly-table th {
    width: auto !important; 
}

.text-translation table.monthly-table {
    table-layout: fixed !important;
    width: 100% !important;
}
        .export-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .export-button {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            font-size: 16px;
            background-color: #007BFF;
            border-radius: 50px;
            padding: 10px 20px;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .export-button:hover {
            background-color: #0056b3;
            transform: translateY(-5px);
        }
        @media (max-width: 600px) {
            .text-translation table th, .text-translation table td {
                font-size: 12px;
                padding: 6px;
                white-space: normal;
            }
            .festival-selection-container select {
                width: 100%;
                padding: 10px;
                font-size: 14px;
            }
            .festival-selection-container button {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                margin-top: 10px;
            }
        }
        @media (min-width: 601px) and (max-width: 1024px) {
            .text-translation table th, .text-translation table td {
                font-size: 14px;
                padding: 8px;
                white-space: normal;
            }
            .festival-selection-container select {
                width: 100%;
                padding: 10px;
                font-size: 14px;
            }
            .festival-selection-container button {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                margin-top: 10px;
            }
        }
        @media (min-width: 1025px) {
            .text-translation table th, .text-translation table td {
                font-size: 16px;
                padding: 10px;
                white-space: normal;
            }
            .festival-selection-container select {
                width: 100%;
                padding: 10px;
                font-size: 16px;
            }
            .festival-selection-container button {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                margin-top: 10px;
            }
        }
        .header-table {
            background: linear-gradient(90deg, #007BFF, #0056b3);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            animation: colorChange 5s infinite alternate;
            border-radius: 5px;
            margin-bottom: 20px;
        }
         /* Añadir margen inferior a las tablas para separarlas */
        .text-translation table {
            margin-bottom: 20px; /* Ajusta este valor según tus necesidades */
        }

        /* Añadir margen superior al contenedor de las gráficas para separarlo del botón del año */
        .stats-container {
            margin-top: 20px; /* Ajusta este valor según tus necesidades */
        }

        .visitor-counter {
            background-color: #333;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .social-media-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .social-media-buttons a {
            margin: 0 10px;
        }
        .social-media-buttons img {
            width: 30px;
            height: 30px;
        }
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #f4f4f4;
        }
        ::-webkit-scrollbar-thumb {
            background: #FFA500;
            border-radius: 10px;
            border: 2px solid #000;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #FF8C00;
        }
        .modern-title-effect {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
            animation: title-glow 2s ease-in-out infinite alternate,
                       zoom-pulse 3s ease-in-out infinite,
                       blur-focus 4s ease-in-out infinite;
        }

        @keyframes title-glow {
            0% { text-shadow: 0 0 10px rgba(78, 205, 196, 0.3); }
            100% { text-shadow: 0 0 25px rgba(255, 107, 107, 0.7); }
        }

        @keyframes zoom-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blur-focus {
            0%, 100% {
                filter: blur(0px);
                opacity: 1;
            }
            50% {
                filter: blur(2px);
                opacity: 0.8;
            }
        }
        .year-buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .year-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }

        .year-button:hover {
            background-color: #0056b3;
        }

        .year-button.active {
            background-color: #0056b3;
            font-weight: bold;
        }
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
 #tabla-total-2025 thead th {
    background-color: #FFE5B4 !important; /* Mantiene el naranja suave */
    font-size: clamp(10px, 2.5vw, 16px) !important;
    white-space: normal !important;
    padding: 8px 4px !important;
    word-wrap: break-word;
    line-height: 1.2;
    color: #333 !important; /* Mantiene el color de texto original */
}

#tabla-total-2025 {
    table-layout: auto !important;
}

@media (max-width: 480px) {
    #tabla-total-2025 thead th {
        font-size: 10px !important;
        padding: 6px 2px !important;
    }
    
    #tabla-total-2025 td {
        font-size: 11px !important;
        padding: 6px !important;
    }
}
        /* Nuevos estilos para la tabla de meses */
        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .month-group td {
            background: linear-gradient(90deg, #007BFF, #0056b3) !important;
            color: white !important;
            font-weight: bold;
            padding: 15px !important;
            text-align: center !important;
            font-size: 1.1em;
            letter-spacing: 1px;
        }


/* Asegurar que la tabla use todo el espacio disponible */
.text-translation table {
    table-layout: fixed !important;
    width: 100% !important;
}

        .data-row:nth-child(even) {
            background-color: #f8f9fa;
        }
        .header-row th {
    background-color: #f2f2f2;
    font-weight: bold;
    border-bottom: 2px solid #ddd;
}
/* Nueva regla corregida */
.text-translation table.monthly-table td.orquesta-column {
    width: 70% !important;
    padding: 11px;
    text-align: left !important;
    border-bottom: 1px solid #ddd;
}

.text-translation table.monthly-table td.actuaciones-column {
    width: 30% !important;
    padding: 11px;
    text-align: center !important;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
    color: #2c3e50;
}

/* Resetear padding general */
.text-translation table.monthly-table td,
.text-translation table.monthly-table th {
    padding: 11px !important; /* Unificar padding */
    text-decoration: none !important; /* Eliminar subrayado */
}

/* Forzar layout fijo */
.text-translation table.monthly-table {
    table-layout: fixed !important;
    width: 100% !important;
}
/* ===== [1. ELIMINAR REGLAS CONFLICTIVAS PREVIAS] ===== */
/* Buscar y eliminar estas declaraciones si existen en el código */
.actuaciones-column,
.orquesta-column,
.text-translation table td, 
.text-translation table th {
    width: auto !important; /* Neutralizar reglas anteriores */
    font-size: inherit !important;
}

/* ===== [2. NUEVO ESTILO PARA TABLAS MENSUALES] ===== */
.text-translation table.monthly-table {
    table-layout: fixed !important;
    width: 100% !important;
    font-size: 1.0em !important; /* Tamaño base reducido */
}

/* ===== [3. ESTILOS ESPECÍFICOS COLUMNAS] ===== */
/* Columna Orquesta (70%) */
.text-translation table.monthly-table td.orquesta-column,
.text-translation table.monthly-table th.orquesta-column {
    width: 70% !important;
    min-width: 70% !important;
    max-width: 70% !important;
    font-size: 1.2em !important; /* Tamaño específico */
    padding: 8px 10px !important;
    line-height: 1.2;
}

/* Columna Actuaciones (30%) */
.text-translation table.monthly-table td.actuaciones-column,
.text-translation table.monthly-table th.actuaciones-column {
    width: 30% !important;
    min-width: 30% !important;
    max-width: 30% !important;
    font-size: 1.2em !important; /* Tamaño ligeramente menor */
    padding: 8px 10px !important;
}

/* ===== [4. AJUSTES RESPONSIVOS] ===== */
@media (max-width: 768px) {
    .text-translation table.monthly-table {
        font-size: 0.85em !important; /* Más pequeño en móviles */
    }
    
    .text-translation table.monthly-table td.orquesta-column {
        font-size: 0.88em !important;
    }
}

/* ===== [5. ANULAR HERENCIAS PELIGROSAS] ===== */
.text-translation table.monthly-table * {
    box-sizing: border-box !important;
    word-wrap: break-word !important;
}
.monthly-events-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

.monthly-events-table th, .monthly-events-table td {
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid #ddd;
}

.monthly-events-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.monthly-events-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.monthly-events-table tr:hover {
    background-color: #f5f5f5;
}
.maps-icon {
    transition: transform 0.2s ease;
}

.maps-icon:hover {
    transform: scale(1.2);
}

    </style>
</head>
<body>
    <div class="header">
        Verbenas en Tenerife
    </div>
    <div class="container">
        <div class="complete-events-container" id="completeEventsContainer">
        </div>
        <div class="map-explanation" style="background: linear-gradient(90deg, #007BFF, #0056b3); color: white; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); padding: 10px; text-align: center; border-radius: 5px; margin-top: 20px; animation: colorChange 5s infinite alternate;">
            UBICACIÓN APROXIMADA DE LAS VERBENAS
        </div>
        <div id="loading-bar" style="background: linear-gradient(90deg, #007BFF, #0056b3); color: white; font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); padding: 10px; text-align: center; border-radius: 5px; margin-top: 10px; animation: colorChange 5s infinite alternate;">
            <div class="progress-bar" style="width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; position: relative;">
                <div class="progress" style="width: 0%; height: 100%; background-color: #9370DB; border-radius: 10px;">
                    <span id="progress-text" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 9.7px; color: black;">Cargando verbenas en el mapa...</span>
                </div>
            </div>
        </div>
        <div id="map"></div>
      
        <div class="year-buttons-container" id="yearButtonsContainer">
            <!-- Los botones de años se generarán aquí dinámicamente -->
        </div>
        <div class="text-translation" id="text-translation">
            <div class="header-table">TABLAS DE ESTADÍSTICAS</div>
        </div>

        <div class="stats-container">
            <h2 class="modern-title-effect" id="currentYearStatsHeader">Gráfica de Número de Actuaciones del Año Actual</h2>
            <canvas id="statsChartCurrentYear"></canvas>
            <h2 style="color: white; text-decoration: underline; font-style: italic;" id="nextYearStatsHeader">Estadísticas del Año Siguiente</h2>
            <canvas id="statsChartNextYear"></canvas>
            <div id="curious-data"></div>
        </div>
        <div class="visitor-counter" id="visitorCounter">
            <p id="visitCount" class="text-white text-lg font-bold modern-title-effect">Cargando...</p>
        </div>
        <div class="social-media-buttons">
            <p>Síguenos en:</p>
            <a href="https://www.facebook.com/debelingoconangel/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Facebook_icon.svg/1200px-Facebook_icon.svg.png" alt="Facebook"></a>
            <a href="https://whatsapp.com/channel/0029Va8nc2A77qVZokI0aC2K"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp"></a>
            <a href="https://t.me/debelingoconangel"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Telegram_logo.svg/1200px-Telegram_logo.svg.png" alt="Telegram"></a>
            <a href="https://www.instagram.com/debelingoconangel/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/1200px-Instagram_icon.png" alt="Instagram"></a>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCg1OiMDsmfoAGpSVYRnvWdl4tSPnLVoUo",
            authDomain: "debelingoconangel.firebaseapp.com",
            databaseURL: "https://debelingoconangel-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "debelingoconangel",
            storageBucket: "debelingoconangel.appspot.com",
            messagingSenderId: "690632293636",
            appId: "1:690632293636:web:5ccf13559fccf3d53a2451",
            measurementId: "G-T8BV0MLJQJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const eventsRef = ref(db, 'events');
        const visitCountRef = ref(db, 'visitCount');

        let events = [];
        let currentYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
        
            updateVisitCount();
            initMap();
            generateYearButtons();
            showLoadingBar(); // Mostrar la barra de progreso al inicio
        });

        function showLoadingBar() {
            const loadingBar = document.getElementById('loading-bar');
            loadingBar.style.display = 'block';
        }

        function hideLoadingBar() {
            const loadingBar = document.getElementById('loading-bar');
            loadingBar.style.display = 'none';
        }

        function loadEvents() {
            onValue(eventsRef, (snapshot) => {
                const loadedEvents = [];
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        const event = { id: key, ...value };
                        if (!event.FechaEditado) {
                            event.FechaEditado = event.FechaAgregado;
                        }
                        loadedEvents.push(event);
                    });
                }
                events = loadedEvents;
                console.log('Eventos cargados:', events);
                renderCompleteEventsList(loadedEvents);
                updateStats();
                addMarkers();
                updateMonthlyOrquestaCountTable(currentYear);
                updateTotalActuacionesTable(currentYear);
                updateMonthlyEventsTable(currentYear); // ← Nueva línea
            });
        }

        function renderCompleteEventsList(events) {
    const completeEventsContainer = document.getElementById('completeEventsContainer');
    completeEventsContainer.innerHTML = ''; // Limpiar contenedor

    events.sort((a, b) => {
        const dateA = new Date(`${a.day}T${a.hora}`);
        const dateB = new Date(`${b.day}T${b.hora}`);
        return dateA - dateB;
    });

    const eventsByDay = {};
    events.forEach(event => {
        const eventDate = new Date(event.day);
        const twoDaysAgo = new Date();
        twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);

        if (eventDate >= twoDaysAgo) {
            const dayKey = eventDate.toISOString().split('T')[0];
            if (!eventsByDay[dayKey]) {
                eventsByDay[dayKey] = [];
            }
            eventsByDay[dayKey].push(event);
        }
    });

    for (const dayKey in eventsByDay) {
        const dayEvents = eventsByDay[dayKey];
        const dayDate = new Date(dayKey);
        const dayName = dayDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        const capitalizedDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);

        const dayHeader = document.createElement('h3');
        dayHeader.textContent = capitalizedDayName;
        dayHeader.style.color = 'lightcoral';
        dayHeader.style.textDecoration = 'underline';
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.textAlign = 'center';
        completeEventsContainer.appendChild(dayHeader);

        dayEvents.forEach(event => {
            let eventText = `${event.hora}H | `;

            if (event.tipo !== 'Baile Normal') {
                eventText += `<span style="color: #87CEEB;">${event.tipo}</span> | `;
            }

            eventText += `${event.lugar ? event.lugar + ', ' : ''}${event.municipio} - `;

            const eventParagraph = document.createElement('p');
            eventParagraph.style.textAlign = 'center';
            eventParagraph.style.display = 'flex';
            eventParagraph.style.alignItems = 'center';
            eventParagraph.style.justifyContent = 'center';
            
            // Crear contenedor para el texto del evento
            const eventTextSpan = document.createElement('span');
            eventTextSpan.innerHTML = eventText + `<span style="color: lightgreen;">${event.orquesta}</span>`;
            
            // Crear icono de Google Maps
            const mapsIcon = document.createElement('a');
            mapsIcon.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.lugar ? `${event.lugar}, ${event.municipio}, Tenerife` : `${event.municipio}, Tenerife`)}`;
            mapsIcon.target = '_blank';
            mapsIcon.rel = 'noopener noreferrer';
            mapsIcon.title = 'Abrir en Google Maps';
            mapsIcon.style.marginLeft = '10px';
            mapsIcon.style.cursor = 'pointer';
            mapsIcon.innerHTML = '<img src="https://maps.gstatic.com/faviconV2.ico" alt="Google Maps" style="width: 16px; height: 16px;">';
            mapsIcon.classList.add('maps-icon');
            eventParagraph.appendChild(eventTextSpan);
            eventParagraph.appendChild(mapsIcon);
            completeEventsContainer.appendChild(eventParagraph);
        });
    }

    const lastUpdateDate = getLastUpdateDate(events);
    const lastUpdateParagraph = document.createElement('p');
    lastUpdateParagraph.className = 'last-update';
    lastUpdateParagraph.textContent = `Última actualización: ${lastUpdateDate}`;
    lastUpdateParagraph.style.textAlign = 'center';
    completeEventsContainer.appendChild(lastUpdateParagraph);

    const exportButtonContainer = document.createElement('div');
    exportButtonContainer.className = 'export-button-container';
    exportButtonContainer.style.textAlign = 'center';

    const exportWeekButton = document.createElement('button');
    exportWeekButton.className = 'export-button';
    exportWeekButton.textContent = 'Exportar eventos de la semana en curso';
    exportWeekButton.addEventListener('click', exportWeekToImage);

    const exportSpecificFestivalButton = document.createElement('button');
    exportSpecificFestivalButton.className = 'export-button';
    exportSpecificFestivalButton.textContent = 'Exportar fiesta en concreto';
    exportSpecificFestivalButton.addEventListener('click', showFestivalSelection);

    exportButtonContainer.appendChild(exportWeekButton);
    exportButtonContainer.appendChild(exportSpecificFestivalButton);
    completeEventsContainer.appendChild(exportButtonContainer);
}
       
   

        let festivalSelectionContainer = null;

        function showFestivalSelection() {
            if (festivalSelectionContainer) {
                festivalSelectionContainer.remove();
                festivalSelectionContainer = null;
                return;
            }

            festivalSelectionContainer = document.createElement('div');
            festivalSelectionContainer.className = 'festival-selection-container';
            festivalSelectionContainer.style.marginTop = '20px';
            festivalSelectionContainer.style.textAlign = 'center';

            const festivalSelectionLabel = document.createElement('label');
            festivalSelectionLabel.textContent = 'Selecciona una fiesta:';
            festivalSelectionLabel.style.marginRight = '10px';

            const festivalSelection = document.createElement('select');
            festivalSelection.style.padding = '10px';
            festivalSelection.style.fontSize = '16px';
            festivalSelection.style.color = 'black';
            festivalSelection.style.backgroundColor = 'white';

            const currentEvents = events.filter(event => {
                const eventDate = new Date(event.day);
                const twoDaysAgo = new Date();
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                return eventDate >= twoDaysAgo;
            });

            const uniqueFestivals = [...new Set(currentEvents.map(event => {
                return event.lugar ? `${event.lugar}, ${event.municipio}` : event.municipio;
            }))];

            uniqueFestivals.forEach(festival => {
                const option = document.createElement('option');
                option.value = festival;
                option.textContent = `Verbenas de ${festival}`;
                festivalSelection.appendChild(option);
            });

            const exportFestivalButton = document.createElement('button');
            exportFestivalButton.className = 'export-button';
            exportFestivalButton.textContent = 'Exportar';
            exportFestivalButton.style.display = 'block';
            exportFestivalButton.style.margin = '20px auto';
            exportFestivalButton.addEventListener('click', () => exportFestivalToImage(festivalSelection.value));

            festivalSelectionContainer.appendChild(festivalSelectionLabel);
            festivalSelectionContainer.appendChild(festivalSelection);
            festivalSelectionContainer.appendChild(exportFestivalButton);

            const completeEventsContainer = document.getElementById('completeEventsContainer');
            completeEventsContainer.appendChild(festivalSelectionContainer);
        }

function exportFestivalToImage(selectedFestival) {
    let lugar, municipio;
    if (selectedFestival.includes(',')) {
        [lugar, municipio] = selectedFestival.split(', ');
    } else {
        lugar = '';
        municipio = selectedFestival;
    }

    // Calcular fecha de corte (hace 2 días)
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - 2);
    cutoffDate.setHours(0, 0, 0, 0); // Resetear a inicio del día
    const cutoffDateString = cutoffDate.toISOString().split('T')[0];

    // Filtrar eventos futuros incluyendo 2 días atrás
    const festivalEvents = events.filter(event =>
        event.lugar === lugar &&
        event.municipio === municipio &&
        event.day >= cutoffDateString
    );

    // --- NUEVA LÓGICA ---
    // Definimos el umbral a partir del cual usaremos dos columnas
    const COLUMN_THRESHOLD = 7;
    const totalEvents = festivalEvents.length;
    // --- FIN NUEVA LÓGICA ---

    // Creamos el contenedor temporal y le forzamos dimensiones fijas para la imagen final.
    const tempContainer = document.createElement('div');
    tempContainer.style.width = '1200px';
    tempContainer.style.height = '1200px';
    tempContainer.style.position = 'relative';
    tempContainer.style.padding = '20px';
    tempContainer.style.textAlign = 'center';
    tempContainer.style.margin = '0 auto';
    tempContainer.style.borderRadius = '10px';
    tempContainer.style.boxSizing = 'border-box';
    tempContainer.style.overflow = 'hidden';
    tempContainer.style.display = 'flex';
    tempContainer.style.flexDirection = 'column';
    tempContainer.style.justifyContent = 'center';
    tempContainer.style.alignItems = 'center';
    tempContainer.style.maxWidth = '1200px';

    const backgroundDiv = document.createElement('div');
    backgroundDiv.style.position = 'absolute';
    backgroundDiv.style.top = '0';
    backgroundDiv.style.left = '0';
    backgroundDiv.style.width = '100%';
    backgroundDiv.style.height = '100%';
    backgroundDiv.style.backgroundSize = 'cover';
    backgroundDiv.style.backgroundPosition = 'center';
    backgroundDiv.style.opacity = '0.5';

    const baseUrls = [
        'https://admindebelingo.web.app/fotos/',
        'https://debelingo.webcindario.com/',
        'http://debelingoconangel.infy.uk/fotos/'
    ];

    const normalizedLugar = lugar
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ñ/g, 'n')
        .replace(/\s+/g, '');
    const normalizedMunicipio = municipio
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ñ/g, 'n')
        .replace(/\s+/g, '');

    const possibleImages = [
        `${baseUrls[0]}${normalizedLugar}.jpg`, `${baseUrls[1]}${normalizedLugar}.jpg`, `${baseUrls[2]}${normalizedLugar}.jpg`,
        `${baseUrls[0]}${normalizedLugar}.png`, `${baseUrls[1]}${normalizedLugar}.png`, `${baseUrls[2]}${normalizedLugar}.png`,
        `${baseUrls[0]}${normalizedLugar}.PNG`, `${baseUrls[1]}${normalizedLugar}.PNG`, `${baseUrls[2]}${normalizedLugar}.PNG`,
        `${baseUrls[0]}${normalizedLugar}.JPG`, `${baseUrls[1]}${normalizedLugar}.JPG`, `${baseUrls[2]}${normalizedLugar}.JPG`,
        `${baseUrls[0]}${normalizedLugar}.jpeg`, `${baseUrls[1]}${normalizedLugar}.jpeg`, `${baseUrls[2]}${normalizedLugar}.jpeg`,
        `${baseUrls[0]}${normalizedLugar}.JPEG`, `${baseUrls[1]}${normalizedLugar}.JPEG`, `${baseUrls[2]}${normalizedLugar}.JPEG`,
        `${baseUrls[0]}${normalizedMunicipio}.jpg`, `${baseUrls[0]}${normalizedMunicipio}.png`,
        `${baseUrls[0]}${normalizedLugar}_${normalizedMunicipio}.jpg`, `${baseUrls[0]}${normalizedMunicipio}_${normalizedLugar}.JPG`,
        `${baseUrls[0]}${normalizedMunicipio}_${normalizedLugar}.jpg`, `${baseUrls[0]}${normalizedLugar}_${normalizedMunicipio}.JPG`,
        `${baseUrls[0]}${normalizedLugar}_${normalizedMunicipio}.png`, `${baseUrls[0]}${normalizedMunicipio}_${normalizedLugar}.png`,
        `${baseUrls[1]}${normalizedMunicipio}.jpg`, `${baseUrls[1]}${normalizedMunicipio}.JPG`, `${baseUrls[1]}${normalizedMunicipio}.png`,
        `${baseUrls[1]}${normalizedLugar}_${normalizedMunicipio}.jpg`, `${baseUrls[1]}${normalizedMunicipio}_${normalizedLugar}.jpg`,
        `${baseUrls[1]}${normalizedLugar}_${normalizedMunicipio}.JPG`, `${baseUrls[1]}${normalizedMunicipio}_${normalizedLugar}.JPG`,
        `${baseUrls[1]}${normalizedLugar}_${normalizedMunicipio}.png`, `${baseUrls[1]}${normalizedMunicipio}_${normalizedLugar}.png`,
        `${baseUrls[2]}${normalizedMunicipio}.jpg`, `${baseUrls[2]}${normalizedMunicipio}.JPG`, `${baseUrls[2]}${normalizedMunicipio}.png`,
        `${baseUrls[2]}${normalizedLugar}_${normalizedMunicipio}.jpg`, `${baseUrls[2]}${normalizedMunicipio}_${normalizedLugar}.jpg`,
        `${baseUrls[2]}${normalizedLugar}_${normalizedMunicipio}.JPG`, `${baseUrls[2]}${normalizedMunicipio}_${normalizedLugar}.JPG`,
        `${baseUrls[2]}${normalizedLugar}_${normalizedMunicipio}.png`, `${baseUrls[2]}${normalizedMunicipio}_${normalizedLugar}.png`
    ];

    function tryNextImage(index) {
        if (index >= possibleImages.length) {
            backgroundDiv.style.backgroundColor = 'white';
            createContent();
            return;
        }

        const img = new Image();
        img.src = possibleImages[index];
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            backgroundDiv.style.backgroundImage = `url('${possibleImages[index]}')`;
            createContent();
        };
        img.onerror = () => tryNextImage(index + 1);
    }

    function createContent() {
        const contentDiv = document.createElement('div');
        contentDiv.style.position = 'relative';
        contentDiv.style.zIndex = '10';
        contentDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
        contentDiv.style.border = '1px solid #000000';
        contentDiv.style.padding = '20px';
        contentDiv.style.borderRadius = '10px';
        contentDiv.style.maxWidth = '100%';
        contentDiv.style.overflow = 'hidden';
        contentDiv.style.display = 'flex';
        contentDiv.style.flexDirection = 'column';
        contentDiv.style.justifyContent = 'center';
        contentDiv.style.alignItems = 'center';
        contentDiv.style.boxSizing = 'border-box';
        contentDiv.style.width = '98%';
        contentDiv.style.marginLeft = '1%';
        contentDiv.style.marginRight = '1%';

        const generationDate = document.createElement('p');
        generationDate.style.fontSize = '0.8em';
        generationDate.style.color = '#888888';
        generationDate.style.marginBottom = '5px';
        generationDate.style.fontFamily = 'Arial, sans-serif';
        generationDate.textContent = `Generado ${new Date().toLocaleString('es-ES')}`;
        contentDiv.appendChild(generationDate);

        const festivalHeader = document.createElement('h2');
        festivalHeader.style.color = '#330000';
        festivalHeader.style.fontWeight = 'bold';
        festivalHeader.style.textDecoration = 'underline';
        festivalHeader.style.textDecorationColor = '#330000';
        festivalHeader.style.marginBottom = '10px';
        festivalHeader.style.fontSize = '3em';
        festivalHeader.style.fontFamily = 'Impact, sans-serif';
        festivalHeader.style.textShadow = `-2px -2px 0 yellow, 2px 2px 0 gold`;
        festivalHeader.style.border = '6px solid #000000';
        festivalHeader.style.backgroundColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 0.7)`;
        festivalHeader.style.padding = '2px 5px 5px 5px';
        festivalHeader.textContent = lugar ? `VERBENAS ${lugar.toUpperCase()}-${municipio.toUpperCase()}` : `VERBENAS ${municipio.toUpperCase()}`;
        contentDiv.appendChild(festivalHeader);

        // Ordenar eventos por fecha y hora
        festivalEvents.sort((a, b) => new Date(`${a.day}T${a.hora}`) - new Date(`${b.day}T${b.hora}`));

        const eventsByDay = {};
        festivalEvents.forEach(event => {
            const dayKey = new Date(event.day).toISOString().split('T')[0];
            if (!eventsByDay[dayKey]) eventsByDay[dayKey] = [];
            eventsByDay[dayKey].push(event);
        });

        const dayKeys = Object.keys(eventsByDay);

        // --- INICIO DE LA LÓGICA DE COLUMNAS CORREGIDA ---
        const eventsContainer = document.createElement('div');
        eventsContainer.style.width = '100%';
        eventsContainer.style.margin = '0 auto';

        if (totalEvents >= COLUMN_THRESHOLD) {
            // Usar CSS Columns para distribución automática y equilibrada
            eventsContainer.style.columnCount = '2';
            eventsContainer.style.columnGap = '30px';
            eventsContainer.style.columnFill = 'balance';

            dayKeys.forEach(dayKey => {
                const daySection = document.createElement('div');
                daySection.style.breakInside = 'avoid'; // Evita partir un día entre columnas
                daySection.style.marginBottom = '15px';

                const dayEvents = eventsByDay[dayKey];
                const dayDate = new Date(dayKey);
                const dayName = dayDate.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                }).toUpperCase();

                const dayHeader = document.createElement('h3');
                dayHeader.textContent = dayName;
                dayHeader.style.color = '#006400';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textDecoration = 'underline';
                dayHeader.style.textDecorationColor = '#006400';
                dayHeader.style.marginBottom = '8px';
                dayHeader.style.fontSize = '1.8em';
                dayHeader.style.fontFamily = 'Impact, sans-serif';
                dayHeader.style.textShadow = `-2px -2px 0 yellow, 2px 2px 0 gold`;
                daySection.appendChild(dayHeader);

                dayEvents.forEach(event => {
                    let eventText = `<strong style="font-size: 1.3em; color: blue;">${event.hora}H</strong>|`;
                    if (event.tipo !== 'Baile Normal') {
                        eventText += `<strong style="font-size: 1.3em;">${event.tipo}</strong>|`;
                    }
                    eventText += `<strong style="font-size: 1.3em; color: black; font-family: Helvetica Black, sans-serif; text-shadow: -2px -2px 0 red, 2px 2px 0 red;">${event.orquesta}</strong>`;

                    const eventParagraph = document.createElement('p');
                    eventParagraph.innerHTML = eventText;
                    eventParagraph.style.color = '#000000';
                    eventParagraph.style.margin = '3px 0';
                    eventParagraph.style.fontSize = '1.3em';
                    eventParagraph.style.fontFamily = 'Impact, sans-serif';
                    eventParagraph.style.textShadow = `-2px -2px 0 yellow, 2px 2px 0 gold`;
                    daySection.appendChild(eventParagraph);
                });

                eventsContainer.appendChild(daySection);
            });
        } else {
            // Una sola columna: mantener diseño original
            dayKeys.forEach(dayKey => {
                const dayEvents = eventsByDay[dayKey];
                const dayDate = new Date(dayKey);
                const dayName = dayDate.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                }).toUpperCase();

                const dayHeader = document.createElement('h3');
                dayHeader.textContent = dayName;
                dayHeader.style.color = '#006400';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textDecoration = 'underline';
                dayHeader.style.textDecorationColor = '#006400';
                dayHeader.style.marginBottom = '8px';
                dayHeader.style.fontSize = '2em';
                dayHeader.style.fontFamily = 'Impact, sans-serif';
                dayHeader.style.textShadow = `-2px -2px 0 yellow, 2px 2px 0 gold`;
                eventsContainer.appendChild(dayHeader);

                dayEvents.forEach(event => {
                    let eventText = `<strong style="font-size: 1.5em; color: blue;">${event.hora}H</strong>|`;
                    if (event.tipo !== 'Baile Normal') {
                        eventText += `<strong style="font-size: 1.5em;">${event.tipo}</strong>|`;
                    }
                    eventText += `<strong style="font-size: 1.5em; color: black; font-family: Helvetica Black, sans-serif; text-shadow: -2px -2px 0 red, 2px 2px 0 red;">${event.orquesta}</strong>`;

                    const eventParagraph = document.createElement('p');
                    eventParagraph.innerHTML = eventText;
                    eventParagraph.style.color = '#000000';
                    eventParagraph.style.margin = '3px 0';
                    eventParagraph.style.fontSize = '1.5em';
                    eventParagraph.style.fontFamily = 'Impact, sans-serif';
                    eventParagraph.style.textShadow = `-2px -2px 0 yellow, 2px 2px 0 gold`;
                    eventsContainer.appendChild(eventParagraph);
                });
            });
        }

        contentDiv.appendChild(eventsContainer);
        // --- FIN DE LA LÓGICA DE COLUMNAS ---

        const infoText = document.createElement('p');
        infoText.style.fontSize = '1.8em';
        infoText.style.color = '#FF0000';
        infoText.style.marginTop = '15px';
        infoText.style.fontFamily = 'Arial, sans-serif';
        infoText.innerHTML = '<strong>Más info en: https://admindebelingo.web.app o https://debelingo.webcindario.com</strong>';

        tempContainer.appendChild(backgroundDiv);
        tempContainer.appendChild(contentDiv);
        tempContainer.appendChild(infoText);
        document.body.appendChild(tempContainer);

        // Ajuste dinámico de tamaño de fuente
        setTimeout(() => {
            const containerHeight = 1200;
            const containerPadding = 40;
            const minRequiredHeight = containerHeight * 0.7 - containerPadding;
            const maxAllowedHeight = containerHeight * 0.96 - containerPadding;

            let fontSizeMultiplier = 1;
            let contentHeight = contentDiv.scrollHeight;

            if (contentHeight < minRequiredHeight) {
                const neededMultiplier = minRequiredHeight / contentHeight;
                fontSizeMultiplier = Math.min(neededMultiplier, 2);
            }

            if (contentHeight * fontSizeMultiplier > maxAllowedHeight) {
                fontSizeMultiplier = maxAllowedHeight / contentHeight;
            }

            fontSizeMultiplier = Math.max(fontSizeMultiplier, 0.7);
            fontSizeMultiplier = Math.min(fontSizeMultiplier, 2);

            festivalHeader.style.fontSize = `${3 * fontSizeMultiplier}em`;
            Array.from(contentDiv.querySelectorAll('h3')).forEach(dayHeader => {
                dayHeader.style.fontSize = `${(totalEvents >= COLUMN_THRESHOLD ? 1.8 : 2) * fontSizeMultiplier}em`;
            });
            Array.from(contentDiv.querySelectorAll('p')).forEach(paragraph => {
                paragraph.style.fontSize = `${(totalEvents >= COLUMN_THRESHOLD ? 1.3 : 1.5) * fontSizeMultiplier}em`;
            });

            contentDiv.style.minHeight = `${minRequiredHeight}px`;
            contentDiv.style.display = 'flex';
            contentDiv.style.flexDirection = 'column';
            contentDiv.style.justifyContent = 'center';

            html2canvas(tempContainer, {
                width: 1200,
                height: 1200,
                backgroundColor: null,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${lugar || municipio}_${municipio}_2025.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                document.body.removeChild(tempContainer);
            });
        }, 100);
    }

    tryNextImage(0);
}

        function getLastUpdateDate(events) {
            let lastUpdateDate = null;
            events.forEach(event => {
                const fechaEditado = new Date(event.FechaEditado);
                if (fechaEditado.toString() !== 'Invalid Date' && (!lastUpdateDate || fechaEditado > lastUpdateDate)) {
                    lastUpdateDate = fechaEditado;
                }
            });
            return lastUpdateDate ? lastUpdateDate.toLocaleString('es-ES') : 'N/A';
        }

        function updateStats() {
            updateCurrentYearStats();
            updateNextYearStats();
        }

        function updateCurrentYearStats() {
    let myChartCurrentYear;
    let monthlyChartCurrentYear;

    const orquestaCountCurrentYear = {};
    const municipioCountCurrentYear = {};
    const monthlyOrquestaCountCurrentYear = {};

    onValue(eventsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            Object.entries(data).forEach(([key, value]) => {
                if (!value.cancelado) {
                    const eventYear = new Date(value.day).getFullYear();
                    const month = new Date(value.day).toLocaleDateString('es-ES', { month: 'long' });

                    if (eventYear === currentYear) {
                        const orquestas = value.orquesta.split(',').map(orq => orq.trim());
                        orquestas.forEach(orq => {
                            // Excluir "DJ"
                            if (orq === 'DJ') return; 
                            if (!orquestaCountCurrentYear[orq]) {
                                orquestaCountCurrentYear[orq] = 0;
                            }
                            orquestaCountCurrentYear[orq]++;

                            if (!monthlyOrquestaCountCurrentYear[month]) {
                                monthlyOrquestaCountCurrentYear[month] = {};
                            }
                            if (!monthlyOrquestaCountCurrentYear[month][orq]) {
                                monthlyOrquestaCountCurrentYear[month][orq] = 0;
                            }
                            monthlyOrquestaCountCurrentYear[month][orq]++;
                        });

                        if (!municipioCountCurrentYear[value.municipio]) {
                            municipioCountCurrentYear[value.municipio] = 0;
                        }
                        municipioCountCurrentYear[value.municipio]++;
                    }
                }
            });

            // Ordenar y tomar los 15 primeros
            const sortedOrquestas = Object.entries(orquestaCountCurrentYear)
                .sort(([,a], [,b]) => b - a)  // Orden descendente
                .slice(0, 15);                // Tomar los 15 primeros

            // Crear nuevos objetos con los 15 primeros
            const top15Orquestas = {};
            sortedOrquestas.forEach(([orquesta, count]) => {
                top15Orquestas[orquesta] = count;
            });

            const ctxCurrentYear = document.getElementById('statsChartCurrentYear').getContext('2d');
            if (myChartCurrentYear) {
                myChartCurrentYear.destroy();
            }
            myChartCurrentYear = new Chart(ctxCurrentYear, {
                type: 'bar',
                data: {
                    labels: Object.keys(top15Orquestas),
                    datasets: [{
                        label: 'Número de actuaciones',
                        data: Object.values(top15Orquestas),
                        backgroundColor: Object.keys(top15Orquestas).map(() => {
                            return getRandomColor();
                        }),
                        borderColor: Object.keys(top15Orquestas).map(() => {
                            return 'rgba(0, 0, 0, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // El resto del código para la gráfica mensual se mantiene igual
            const monthlyCtxCurrentYear = document.getElementById('monthlyStatsChartCurrentYear');
            if (monthlyCtxCurrentYear) {
                const monthlyDataCurrentYear = Object.keys(monthlyOrquestaCountCurrentYear).map(month => {
                    const orquestas = Object.keys(monthlyOrquestaCountCurrentYear[month]);
                    const counts = Object.values(monthlyOrquestaCountCurrentYear[month]);
                    return {
                        label: month,
                        data: counts,
                        backgroundColor: orquestas.map(() => getRandomColor()),
                    };
                });

                if (monthlyChartCurrentYear) {
                    monthlyChartCurrentYear.destroy();
                }
                monthlyChartCurrentYear = new Chart(monthlyCtxCurrentYear, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(monthlyOrquestaCountCurrentYear[Object.keys(monthlyOrquestaCountCurrentYear)[0]]),
                        datasets: monthlyDataCurrentYear
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateCuriousData(monthlyOrquestaCountCurrentYear, {});
            updateTextTranslation(orquestaCountCurrentYear, monthlyOrquestaCountCurrentYear, currentYear);
        }
    });
}
        function updateNextYearStats() {
            let myChartNextYear;

            const orquestaCountNextYear = {};
            const municipioCountNextYear = {};

            onValue(eventsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        if (!value.cancelado) {
                            const eventYear = new Date(value.day).getFullYear();

                            if (eventYear === currentYear + 1) {
                                const orquestas = value.orquesta.split(',').map(orq => orq.trim());
                                orquestas.forEach(orq => {
                                    // Excluir "DJ"
                                   if (orq === 'DJ') return; 
                                    if (!orquestaCountNextYear[orq]) {
                                        orquestaCountNextYear[orq] = 0;
                                    }
                                    orquestaCountNextYear[orq]++;
                                });

                                if (!municipioCountNextYear[value.municipio]) {
                                    municipioCountNextYear[value.municipio] = 0;
                                }
                                municipioCountNextYear[value.municipio]++;
                            }
                        }
                    });

                    if (Object.keys(orquestaCountNextYear).length > 0) {
                        const ctxNextYear = document.getElementById('statsChartNextYear').getContext('2d');
                        if (myChartNextYear) {
                            myChartNextYear.destroy();
                        }
                        myChartNextYear = new Chart(ctxNextYear, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(orquestaCountNextYear),
                                datasets: [{
                                    label: 'Número de actuaciones',
                                    data: Object.values(orquestaCountNextYear),
                                    backgroundColor: Object.keys(orquestaCountNextYear).map(() => {
                                        return getRandomColor();
                                    }),
                                    borderColor: Object.keys(orquestaCountNextYear).map(() => {
                                        return 'rgba(0, 0, 0, 1)';
                                    }),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        updateCuriousData({}, {});
                        updateTextTranslation(orquestaCountNextYear, {}, currentYear + 1);
                    } else {
                        document.getElementById('nextYearStatsHeader').style.display = 'none';
                        document.getElementById('statsChartNextYear').style.display = 'none';
                    }
                }
            });
        }

        function updateCuriousData(monthlyOrquestaCountCurrentYear, monthlyOrquestaCountNextYear) {
            const curiousDataDiv = document.getElementById('curious-data');

            Object.keys(monthlyOrquestaCountCurrentYear).forEach(orquesta => {
                const maxMonth = Object.keys(monthlyOrquestaCountCurrentYear[orquesta]).reduce((a, b) =>
                    monthlyOrquestaCountCurrentYear[orquesta][a] > monthlyOrquestaCountCurrentYear[orquesta][b] ? a : b
                );
                const maxCount = monthlyOrquestaCountCurrentYear[orquesta][maxMonth];
            });

            Object.keys(monthlyOrquestaCountNextYear).forEach(orquesta => {
                const maxMonth = Object.keys(monthlyOrquestaCountNextYear[orquesta]).reduce((a, b) =>
                    monthlyOrquestaCountNextYear[orquesta][a] > monthlyOrquestaCountNextYear[orquesta][b] ? a : b
                );
                const maxCount = monthlyOrquestaCountNextYear[orquesta][maxMonth];
            });
        }

        function updateTextTranslation(orquestaCount, monthlyOrquestaCount, year) {
    const textTranslationDiv = document.getElementById('text-translation');

    // Eliminar solo la tabla mensual existente para este año, no la tabla de totales
    const existingMonthlyTable = document.getElementById(`tabla-mensual-${year}`);
    if (existingMonthlyTable) existingMonthlyTable.remove();

    // NO creamos la tabla de resumen anual aquí para evitar duplicados
    // Esa tabla ya se crea mediante updateTotalActuacionesTable()

    // Crear solo la tabla mensual
    let monthlyTableHTML = `<table id="tabla-mensual-${year}" class="monthly-table">
        <thead>
            <tr>
                <th class="orquesta-column">FORMACIÓN/SOLISTA</th>
                <th class="actuaciones-column">ACTUACIONES</th>
            </tr>
        </thead>
        <tbody>`;

    const sortedMonths = Object.keys(monthlyOrquestaCount).sort((a, b) => {
        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
                            "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        return monthNames.indexOf(a.toLowerCase()) - monthNames.indexOf(b.toLowerCase());
    });

    sortedMonths.forEach(month => {
        monthlyTableHTML += `<tr class="month-group">
            <td colspan="2">${month.toUpperCase()}</td>
        </tr>`;

        const sortedOrquestas = Object.entries(monthlyOrquestaCount[month])
            .sort(([,a], [,b]) => b - a);

        sortedOrquestas.forEach(([orquesta, count]) => {
            monthlyTableHTML += `<tr class="data-row">
                <td class="orquesta-column">${orquesta}</td>
                <td class="actuaciones-column">${count}</td>
            </tr>`;
        });
    });

    monthlyTableHTML += `</tbody></table>`;
    
}

       function updateMonthlyOrquestaCountTable(year) {
    const textTranslationDiv = document.getElementById('text-translation');
    const monthlyOrquestaCount = {};

    return get(eventsRef).then((snapshot) => {
        const data = snapshot.val();
        if (data) {
            Object.entries(data).forEach(([key, value]) => {
                if (!value.cancelado) {
                    const eventYear = new Date(value.day).getFullYear();
                    const month = new Date(value.day).toLocaleDateString('es-ES', { month: 'long' });

                    if (eventYear === year) {
                        const orquestas = value.orquesta.split(',').map(orq => orq.trim());
                        orquestas.forEach(orq => {
                            if (!monthlyOrquestaCount[month]) {
                                monthlyOrquestaCount[month] = {};
                            }
                            if (!monthlyOrquestaCount[month][orq]) {
                                monthlyOrquestaCount[month][orq] = 0;
                            }
                            monthlyOrquestaCount[month][orq]++;
                        });
                    }
                }
            });

            const existingTable = document.getElementById(`tabla-mensual-${year}`);
            if (existingTable) existingTable.remove();

            const sortedMonths = Object.keys(monthlyOrquestaCount).sort((a, b) => {
                const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
                                    "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
                return monthNames.indexOf(a.toLowerCase()) - monthNames.indexOf(b.toLowerCase());
            });

            let tableHTML = `<table id="tabla-mensual-${year}" class="monthly-table">`;

            sortedMonths.forEach(month => {
                tableHTML += `
                    <tbody>
                        <tr class="month-group">
                            <td colspan="2">${month.toUpperCase()}</td>
                        </tr>
                        <tr class="header-row">
                            <th class="orquesta-column">BANDA/SOLISTA</th>
                            <th class="actuaciones-column">ACTUACIONES</th>
                        </tr>`;

                const sortedOrquestas = Object.entries(monthlyOrquestaCount[month])
                    .sort(([,a], [,b]) => b - a);

                sortedOrquestas.forEach(([orquesta, count]) => {
                    tableHTML += `
                        <tr class="data-row">
                            <td class="orquesta-column">${orquesta}</td>
                            <td class="actuaciones-column">${count}</td>
                        </tr>`;
                });

                tableHTML += `</tbody>`;
            });

            tableHTML += `</table>`;
            textTranslationDiv.innerHTML += tableHTML;
        }
    });
}

        function updateTotalActuacionesTable(year) {
            const textTranslationDiv = document.getElementById('text-translation');
            const totalActuaciones = {};

            return get(eventsRef).then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        if (!value.cancelado) {
                            const eventYear = new Date(value.day).getFullYear();
                            const orquestas = value.orquesta.split(',').map(orq => orq.trim());

                            if (eventYear === year) {
                                orquestas.forEach(orq => {
                                    if (!totalActuaciones[orq]) {
                                        totalActuaciones[orq] = 0;
                                    }
                                    totalActuaciones[orq]++;
                                });
                            }
                        }
                    });

                    // Eliminar tabla total existente
                    const existingTable = document.getElementById(`tabla-total-${year}`);
                    if (existingTable) existingTable.remove();

                    let tableHTML = `<table id="tabla-total-${year}">
                        <thead>
                            <tr>
                                <th>Banda/Solista</th>
                                <th>Número de Actuaciones</th>
                                <th>Año</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    const sortedTotalActuaciones = Object.entries(totalActuaciones)
                        .sort(([, a], [, b]) => b - a)
                        .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});

                    for (const orquesta in sortedTotalActuaciones) {
                        tableHTML += `<tr>
                            <td>${orquesta}</td>
                            <td>${sortedTotalActuaciones[orquesta]}</td>
                            <td>${year}</td>
                        </tr>`;
                    }

                    tableHTML += `</tbody></table>`;
                    textTranslationDiv.innerHTML += tableHTML;
                }
            });
        }
function updateMonthlyEventsTable(year) {
    const textTranslationDiv = document.getElementById('text-translation');
    const monthlyEventsCount = {
        'enero': 0, 'febrero': 0, 'marzo': 0, 'abril': 0, 'mayo': 0, 'junio': 0,
        'julio': 0, 'agosto': 0, 'septiembre': 0, 'octubre': 0, 'noviembre': 0, 'diciembre': 0
    };

    return get(eventsRef).then((snapshot) => {
        const data = snapshot.val();
        if (data) {
            Object.entries(data).forEach(([key, value]) => {
                if (!value.cancelado) {
                    const eventYear = new Date(value.day).getFullYear();
                    if (eventYear === year) {
                        const month = new Date(value.day).toLocaleDateString('es-ES', { month: 'long' }).toLowerCase();
                        if (monthlyEventsCount.hasOwnProperty(month)) {
                            monthlyEventsCount[month]++;
                        }
                    }
                }
            });

            // Eliminar tabla existente si la hay
            const existingTable = document.getElementById(`tabla-eventos-mensual-${year}`);
            if (existingTable) existingTable.remove();

            let tableHTML = `
            
                <table id="tabla-eventos-mensual-${year}" class="monthly-table">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Número de Eventos</th>
                        </tr>
                    </thead>
                    <tbody>`;

            let totalAnual = 0;
            const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
                                "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

            monthNames.forEach(month => {
                const count = monthlyEventsCount[month];
                totalAnual += count;
                tableHTML += `
                    <tr>
                        <td>${month.charAt(0).toUpperCase() + month.slice(1)}</td>
                        <td>${count}</td>
                    </tr>`;
            });

            // Añadir fila de total
            tableHTML += `
                    <tr style="font-weight: bold; background-color: #f2f2f2;">
                        <td>TOTAL ${year}</td>
                        <td>${totalAnual}</td>
                    </tr>
                </tbody>
                </table>`;

            textTranslationDiv.innerHTML += tableHTML;
        }
    });
}
        async function filterTablesByYear(year) {
            const yearButtons = document.querySelectorAll('.year-button');
            yearButtons.forEach(button => {
                button.classList.remove('active');
                if (button.textContent == year) {
                    button.classList.add('active');
                }
            });

            const textTranslationDiv = document.getElementById('text-translation');

            // Ocultar todas las tablas primero
            const tables = textTranslationDiv.querySelectorAll('table');
            tables.forEach(table => table.style.display = 'none');

            // Actualizar tablas y esperar a que se completen
            await updateMonthlyOrquestaCountTable(year);
            await updateTotalActuacionesTable(year);
            await updateMonthlyEventsTable(year); // ← Nueva línea

            // Mostrar solo las tablas del año seleccionado
            const newTables = textTranslationDiv.querySelectorAll('table');
            newTables.forEach(table => {
                const tableYear = parseInt(table.id.split('-').pop());
                table.style.display = tableYear === year ? 'table' : 'none';
            });
        }

        function generateYearButtons() {
            const yearButtonsContainer = document.getElementById('yearButtonsContainer');
            const currentYear = new Date().getFullYear();

            get(eventsRef).then((snapshot) => {
                const data = snapshot.val();
                const years = new Set();

                if (data) {
                    Object.entries(data).forEach(([key, value]) => {
                        const eventYear = new Date(value.day).getFullYear();
                        years.add(eventYear);
                    });

                    yearButtonsContainer.innerHTML = '';

                    years.forEach(year => {
                        const yearButton = document.createElement('button');
                        yearButton.className = 'year-button';
                        yearButton.textContent = year;
                        yearButton.addEventListener('click', () => filterTablesByYear(year));
                        yearButtonsContainer.appendChild(yearButton);
                    });

                    const currentYearButton = Array.from(yearButtonsContainer.children)
                        .find(button => button.textContent == currentYear);
                    if (currentYearButton) {
                        currentYearButton.classList.add('active');
                        filterTablesByYear(currentYear);
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        

        function exportToImage() {
            const completeEventsContainer = document.getElementById('completeEventsContainer');
            const h2Element = completeEventsContainer.querySelector('h2');
            const lastUpdateParagraph = completeEventsContainer.querySelector('.last-update');
            const exportButtonContainer = completeEventsContainer.querySelector('.export-button-container');

            if (h2Element) {
                h2Element.style.display = 'none';
            }
            if (lastUpdateParagraph) {
                lastUpdateParagraph.style.display = 'none';
            }
            if (exportButtonContainer) {
                exportButtonContainer.style.display = 'none';
            }

            html2canvas(completeEventsContainer).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Listado_Completo_de_Eventos.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                if (h2Element) {
                    h2Element.style.display = 'block';
                }
                if (lastUpdateParagraph) {
                    lastUpdateParagraph.style.display = 'block';
                }
                if (exportButtonContainer) {
                    exportButtonContainer.style.display = 'flex';
                }
            });
        }

 




function exportWeekToImage() {
    const completeEventsContainer = document.getElementById('completeEventsContainer');
    const h2Element = completeEventsContainer.querySelector('h2');
    const lastUpdateParagraph = completeEventsContainer.querySelector('.last-update');
    const exportButtonContainer = completeEventsContainer.querySelector('.export-button-container');

    // Ocultar elementos innecesarios
    if (h2Element) h2Element.style.display = 'none';
    if (lastUpdateParagraph) lastUpdateParagraph.style.display = 'none';
    if (exportButtonContainer) exportButtonContainer.style.display = 'none';

    const currentDate = new Date();
    const currentDay = currentDate.getUTCDay();

    // Calcular inicio y fin de la semana
    let startOfWeek = new Date(currentDate);
    startOfWeek.setUTCDate(currentDate.getUTCDate() - currentDay + (currentDay === 0 ? -6 : 1));
    startOfWeek.setUTCHours(0, 0, 0, 0);

    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setUTCDate(startOfWeek.getUTCDate() + 6);
    endOfWeek.setUTCHours(23, 59, 59, 999);

    // Filtrar eventos de la semana
    const weekEvents = events.filter(event => {
        const eventDate = new Date(event.day);
        const eventHour = event.hora || '00:00';
        const eventDateWithHour = new Date(`${eventDate.toISOString().split('T')[0]}T${eventHour}:00Z`);
        return eventDateWithHour >= startOfWeek && eventDateWithHour <= endOfWeek;
    });

    // Crear contenedor temporal
    const tempContainer = document.createElement('div');
    tempContainer.style.backgroundColor = '#ffffff';
    tempContainer.style.color = '#000000';
    tempContainer.style.padding = '20px';
    tempContainer.style.textAlign = 'center';
    tempContainer.style.borderRadius = '10px';
    tempContainer.style.border = '1px solid #000000';
    tempContainer.style.width = '1000px'; // Ancho fijo
    tempContainer.style.margin = '0 auto';
    tempContainer.style.display = 'inline-block'; // Ajustar al contenido

    // Ordenar eventos cronológicamente
    weekEvents.sort((a, b) => new Date(`${a.day}T${a.hora}`) - new Date(`${b.day}T${b.hora}`));

    // Agrupar eventos por día
    const eventsByDay = {};
    weekEvents.forEach(event => {
        const dayKey = new Date(event.day).toISOString().split('T')[0];
        if (!eventsByDay[dayKey]) eventsByDay[dayKey] = [];
        eventsByDay[dayKey].push(event);
    });

    // Procesar cada día y sus eventos
    for (const dayKey in eventsByDay) {
        const dayEvents = eventsByDay[dayKey];
        const dayDate = new Date(dayKey);
        const dayName = dayDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

        // Crear encabezado del día (solo una vez)
        const dayHeader = document.createElement('h3');
        dayHeader.textContent = dayName;
        dayHeader.style.color = '#000000'; // Negro
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.textDecoration = 'underline';
        dayHeader.style.marginBottom = '5px';
        tempContainer.appendChild(dayHeader);

        // Procesar cada evento del día
        dayEvents.forEach(event => {
            let eventText = `${event.hora}H|`;
            if (event.tipo !== 'Baile Normal') {
                eventText += `<strong>${event.tipo}</strong>|`;
            }
            eventText += `<strong>${event.municipio}, ${event.lugar}</strong>|`;
            eventText += `<strong style="color: blue;">${event.orquesta}</strong>`;

            const eventParagraph = document.createElement('p');
            eventParagraph.innerHTML = eventText;
            eventParagraph.style.color = '#000000';
            eventParagraph.style.margin = '0';
            eventParagraph.style.marginBottom = '8px';
            tempContainer.appendChild(eventParagraph);
        });
    }

    // Agregar información adicional
    const infoText = document.createElement('p');
    infoText.style.fontSize = '1.0em';
    infoText.style.color = '#FF0000';
    infoText.style.marginTop = '10px';
    infoText.textContent = 'Info.Act.:https://admindebelingo.web.app';
    tempContainer.appendChild(infoText);

    const identifier = document.createElement('p');
    identifier.style.color = '#000000';
    identifier.style.fontSize = '12px';
    identifier.style.marginTop = '10px';
    identifier.textContent = `Generado el ${currentDate.toLocaleDateString('es-ES')}`;
    tempContainer.appendChild(identifier);

    document.body.appendChild(tempContainer);

    // Generar imagen
    html2canvas(tempContainer, { backgroundColor: '#ffffff' }).then(canvas => {
        const startDateStr = startOfWeek.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
        const endDateStr = endOfWeek.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
        const year = currentDate.getFullYear();
        const link = document.createElement('a');
        link.download = `Eventos_${startDateStr}_al_${endDateStr}_${year}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        // Restaurar elementos
        document.body.removeChild(tempContainer);
        if (h2Element) h2Element.style.display = 'block';
        if (lastUpdateParagraph) lastUpdateParagraph.style.display = 'block';
        if (exportButtonContainer) exportButtonContainer.style.display = 'flex';
    });
}





        function updateVisitCount() {
            get(visitCountRef).then((snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('visitCount').textContent = `Número de visitas a la página: ${count}`;
                set(visitCountRef, count + 1);
            }).catch((error) => {
                console.error('Error al obtener el contador de visitas:', error);
            });
        }

        function initMap() {
            const tenerifeBounds = [
                [28.025, -16.925], // Suroeste de Tenerife
                [28.625, -16.075]  // Noreste de Tenerife
            ];

            const tenerifeCenter = [28.291563, -16.629126];

            // 📱 Detectar si es un móvil para ajustar el minZoom
            const isMobile = window.innerWidth < 768; // Si el ancho es menor de 768px (tablets y móviles)

            const map = L.map('map', {
                center: tenerifeCenter,
                zoom: isMobile ? 9.2 : 9.7,  // 📍 En móviles inicia con zoom 9.2, en PC con zoom 9.7
                minZoom: isMobile ? 9.2 : 9.7, // 📌 Móvil: 9.2, PC: 9.7
                maxZoom: 18,         // 🔍 Zoom máximo sigue en 18
                maxBounds: tenerifeBounds, // 📍 Limita a Tenerife
                maxBoundsViscosity: 1.0,   // 🚫 Evita que el usuario se salga de los límites
                zoomControl: true,         // 🔍 Controles de zoom activados
                scrollWheelZoom: true      // 🎡 Permite hacer zoom con la rueda del ratón
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const markers = L.markerClusterGroup();
            map.addLayer(markers);
            addMarkers(map, markers);
        }

       async function addMarkers(map, markers) {
    if (markers) {
        markers.clearLayers();
    }

    const redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [50, 82],
        iconAnchor: [25, 82],
        popupAnchor: [1, -34],
        shadowSize: [82, 82]
    });

    const municipioMapping = {
        "Adeje": "Adeje",
        "Arafo": "Arafo",
        "Arona": "Arona",
        "Buenavista": "Buenavista del Norte",
        "Candelaria": "Candelaria",
        "Rosario": "El Rosario",
        "Sauzal": "El Sauzal",
        "Tanque": "El Tanque",
        "Fasnia": "Fasnia",
        "Garachico": "Garachico",
        "Granadilla": "Granadilla de Abona",
        "Guancha": "La Guancha",
        "Guía": "Guía de Isora",
        "Güímar": "Güímar",
        "Icod": "Icod de los Vinos",
        "Matanza": "La Matanza de Acentejo",
        "Orotava": "La Orotava",
        "Puerto": "Puerto de la Cruz",
        "Realejos": "Los Realejos",
        "Laguna": "San Cristóbal de La Laguna",
        "San Juan Rambla": "San Juan de la Rambla",
        "San Miguel": "San Miguel de Abona",
        "Santa Cruz": "Santa Cruz de Tenerife",
        "Santa Úrsula": "Santa Úrsula",
        "Santiago Teide": "Santiago del Teide",
        "Tacoronte": "Tacoronte",
        "Tegueste": "Tegueste",
        "Victoria": "La Victoria de Acentejo",
        "Vilaflor": "Vilaflor de Chasna",
        "Silos": "Los Silos"
    };

    onValue(eventsRef, async (snapshot) => {
        const data = snapshot.val();
        if (data) {
            let counter = 0;
            const totalEvents = Object.keys(data).length;
            for (const [key, value] of Object.entries(data)) {
                if (counter > 0) await new Promise(resolve => setTimeout(resolve, 1000));
                counter++;

                if (!value.cancelado) {
                    const eventDate = new Date(value.day);
                    const twoDaysAgo = new Date();
                    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);

                    if (eventDate >= twoDaysAgo) {
                        const fullMunicipioName = municipioMapping[value.municipio] || value.municipio;
                        const address = value.lugar ? `${value.lugar}, ${fullMunicipioName}, Tenerife, España` : `${fullMunicipioName}, Tenerife, España`;

                        console.log("Geocodificando:", address);
                        const coordinates = await geocodeAddress(address);
                        console.log("Coordenadas obtenidas:", coordinates);

                        if (coordinates) {
                            const eventDay = new Date(value.day).toLocaleDateString('es-ES', { weekday: 'long' });
                            const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${coordinates.lat},${coordinates.lng}`;
                            const marker = L.marker([coordinates.lat, coordinates.lng], { icon: redIcon })
                                .bindPopup(`${value.orquesta} - ${value.lugar ? value.lugar : fullMunicipioName}<br>Día: ${value.day} (${eventDay})<br>Hora: ${value.hora}<br><a href="${googleMapsLink}" target="_blank">Cómo llegar</a>`);
                            markers.addLayer(marker);
                        }
                    }
                }
                // Actualizar la barra de progreso
                updateProgressBar(counter / totalEvents);
            }
            hideLoadingBar(); // Ocultar la barra de progreso cuando se completa la carga
        }
    });
}

        function updateProgressBar(progress) {
            const progressBar = document.querySelector('#loading-bar .progress');
            const progressText = document.getElementById('progress-text');
            const percentage = Math.round(progress * 100);

            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `Cargando verbenas ${percentage}%`;

            if (percentage === 100) {
                progressText.textContent = 'VERBENAS CARGADAS EN EL MAPA';
            }
        }

        async function geocodeAddress(address) {
            if (!address || address.startsWith(",")) {
                console.warn("Dirección inválida:", address);
                return null;
            }

            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'VerbenasTenerife/1.0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                console.warn("No se encontraron coordenadas para:", address);
                return null;
            } catch (error) {
                console.error("Error en geocodificación:", error);
                return null;
            }
        }
    </script>
</body>
</html>

