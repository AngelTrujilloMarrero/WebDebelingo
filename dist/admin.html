<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Admin-De Belingo Con √Ångel</title>
    <link rel="icon" type="image/jpeg" href="https://debelingoconangel.web.app/fotos/logoredes.jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
        }
        .header {
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .login-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-box h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        .login-box input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .login-box button {
            width: 100%;
            padding: 10px;
            background-color: #1877f2;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .login-box button:hover {
            background-color: #166fe5;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
        .calendar-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
            width: 90%;
            margin-bottom: 20px;
        }
        .current-month, .next-month {
            background-color: #fff;
            color: #000;
        }
        .next-month {
            border: 1px solid #ccc;
        }
        .form-container {
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
        }
        .form-container input, .form-container select {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }
        .events-container {
            background-color: black;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .event {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .event.editing {
            color: red;
        }
        .calendar table {
            width: 100%;
            border-collapse: collapse;
        }
        .calendar th, .calendar td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .calendar td:hover {
            background-color: #f0f0f0;
        }
        .selected {
            background-color: #ccc;
        }
        .btn {
            padding: 15px 30px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-edit, .btn-delete, .btn-save, .btn-cancel {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            margin-bottom: 5px;
        }
        .btn-edit:hover, .btn-delete:hover, .btn-save:hover, .btn-cancel:hover {
            background-color: #d32f2f;
        }
        .flatpickr-input {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }
        .calendar-label h2 {
            color: black;
            margin: 0;
            padding: 10px 0;
            text-transform: uppercase;
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            .form-container {
                width: 100%;
                padding: 10px;
            }
            .form-container input, .form-container select {
                width: 100%;
                margin: 5px 0;
                padding: 10px;
                background-color: white;
                color: black;
                border: 1px solid #ccc;
            }
            .btn {
                width: 100%;
                padding: 15px;
                font-size: 16px;
            }
            .event {
                flex-direction: column; /* Apilar texto y botones verticalmente */
                align-items: flex-start;
            }
            .event > span {
                width: 100%;
                max-width: 100%;
                word-wrap: break-word;
                margin-bottom: 8px; /* Espacio entre texto y botones */
            }
            .event-buttons {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 6px; /* Espaciado entre botones */
            }
            .btn-edit, .btn-delete, .btn-save, .btn-cancel {
                flex: 1 1 45%; /* Dos botones por fila */
                min-width: 120px;
                margin-left: 0;
            }
        }
        .month-divider {
            width: 100%;
            height: 2px;
            background-color: blue;
            position: relative;
            margin: 20px 0;
        }
        .month-divider span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: black;
            color: white;
            padding: 0 10px;
            font-weight: bold;
        }
        .event.lunes {
            border-color: brown; /* Color para lunes */
        }
        .event.martes {
            border-color: orange; /* Color para martes */
        }
        .event.mi√©rcoles {
            border-color: yellow; /* Color para mi√©rcoles */
        }
        .event.jueves {
            border-color: purple; /* Color para jueves */
        }
        .event.viernes {
            border-color: green; /* Color para viernes */
        }
        .event.sabado {
            border-color: white; /* Color para s√°bado */
        }
        .event.domingo {
            border-color: violet; /* Color para domingo */
        }
        .calendar td.lunes {
            background-color: #d2b48c; /* Color suave para lunes */
        }
        .calendar td.martes {
            background-color: #ffdab9; /* Color suave para martes */
        }
        .calendar td.mi√©rcoles {
            background-color: #ffffdb; /* Color suave para mi√©rcoles */
        }
        .calendar td.jueves {
            background-color: #e6e6fa; /* Color suave para jueves */
        }
        .calendar td.viernes {
            background-color: #90ee90; /* Color suave para viernes */
        }
        .calendar td.sabado {
            background-color: #f8f8ff; /* Color suave para s√°bado */
        }
        .calendar td.domingo {
            background-color: #ee82ee; /* Color suave para domingo */
        }
        .toggle-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .toggle-button:hover {
            background-color: #45a049;
        }

        .calendar-container iframe {
            position: relative;
            width: 100%;
            height: 600px; /* Altura base */
            border: none;
        }

        /* Ajustes para tablets */
        @media (max-width: 768px) {
            .calendar-container iframe {
                height: 500px;
            }
        }

        /* Ajustes para m√≥viles */
        @media (max-width: 480px) {
            .calendar-container iframe {
                height: 400px;
            }
        }
.autocomplete-items {
    position: absolute;
    left: 0;
    top: 100%;
    transform: translateY(4px);
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #d4d4d4;
    background-color: white;
    z-index: 9999;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.autocomplete-items div {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.autocomplete-items div:hover {
    background-color: #f1f1f1;
}

.autocomplete-active {
    background-color: #1e90ff !important;
    color: white;
}
    </style>
</head>
<body>
    <div id="login-section" class="login-container">
        <div class="login-box">
            <h2>Iniciar Sesi√≥n</h2>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button onclick="login()">Iniciar Sesi√≥n</button>
            <div id="error-message" class="error-message"></div>
        </div>
    </div>
    <div id="admin-section" style="display: none;">
        <div class="header">
            <div class="calendar-container">
                <div class="calendar current-month" id="currentMonthCalendar">
                    <div class="calendar-label"><h2></h2></div>
                    <table></table>
                </div>
                <div class="calendar next-month" id="nextMonthCalendar">
                    <div class="calendar-label"><h2></h2></div>
                    <table></table>
                </div>
                <div class="calendar next-month" id="nextMonth2Calendar" style="display: none;">
                    <div class="calendar-label"><h2></h2></div>
                    <table></table>
                </div>
                <div class="calendar next-month" id="nextMonth3Calendar" style="display: none;">
                    <div class="calendar-label"><h2></h2></div>
                    <table></table>
                </div>
                <div class="calendar next-month" id="nextMonth4Calendar" style="display: none;">
                    <div class="calendar-label"><h2></h2></div>
                    <table></table>
                </div>
                <button class="toggle-button" id="toggleButton">Desplegar m√°s</button>
            </div>
        </div>
        <div class="form-container" id="form-container">
            <label for="eventDate" style="font-weight: bold;" id="eventDateLabel">Campo D√≠a (Selecciona para largo plazo)</label>
            <input type="date" id="eventDate" value="" placeholder="Selecciona el d√≠a">
            <input type="text" placeholder="Orquesta/Grupo (Si hay varios sep√°ralos por comas)" id="orquesta" style="color: black;" list="orquesta-suggestions">
            <datalist id="orquesta-suggestions"></datalist>
            <input type="text" placeholder="Sitio/Lugar (D√©jalo en blanco si es el sitio habitual o casco). " id="lugar" style="color: black;">
            <select id="municipio">
                <option value="">Selecciona un municipio</option>
                <option value="Adeje">Adeje</option>
                <option value="Arafo">Arafo</option>
                <option value="Arico">Arico</option>
                <option value="Arona">Arona</option>
                <option value="Buenavista">Buenavista</option>
                <option value="Candelaria">Candelaria</option>
                <option value="Rosario">Rosario</option>
                <option value="Sauzal">Sauzal</option>
                <option value="Tanque">Tanque</option>
                <option value="Fasnia">Fasnia</option>
                <option value="Garachico">Garachico</option>
                <option value="Granadilla">Granadilla</option>
                <option value="Guancha">Guancha</option>
                <option value="Gu√≠a">Gu√≠a</option>
                <option value="G√º√≠mar">G√º√≠mar</option>
                <option value="Icod">Icod</option>
                <option value="Matanza">Matanza</option>
                <option value="Orotava">Orotava</option>
                <option value="Puerto">Puerto</option>
                <option value="Realejos">Realejos</option>
                <option value="Laguna">Laguna</option>
                <option value="San Juan Rambla">San Juan Rambla</option>
                <option value="San Miguel">San Miguel</option>
                <option value="Santa Cruz">Santa Cruz</option>
                <option value="Santa √örsula">Santa √örsula</option>
                <option value="Santiago Teide">Santiago Teide</option>
                <option value="Tacoronte">Tacoronte</option>
                <option value="Tegueste">Tegueste</option>
                <option value="Victoria">Victoria</option>
                <option value="Vilaflor">Vilaflor</option>
                <option value="Silos">Silos</option>
            </select>
            <select id="hora">
                <option value="">Seleccione la hora</option>
            </select>
            <select id="tipo">
                <option value="Baile Normal">Baile Normal </option>
                <option value="Romer√≠a">Romer√≠a</option>
                <option value="Baile Magos">Baile De Magos</option>
                <option value="Tapas y Vinos">Tapas y Vinos</option>
                <option value="Paseo Romero">Paseo Romero</option>
                <option value="Tapas">Tapas</option>
                <option value="Romer√≠a Chica">Romer√≠a Chica</option>
                <option value="Carnaval">Carnaval</option>
                <option value="Taifa">Taifa</option>
                <option value="Infantil">Infantil</option>
                <option value="Inclusiva">Inclusiva</option>
                <option value="Vinos">Vinos</option>
                <option value="Aniversario">Aniversario</option>
                <option value="Solidario">Solidario</option>
                <option value="Romer√≠a Barquera">Romer√≠a Barquera</option>
                <option value="Pamela">Pamela</option>
                <option value="Blanco">Blanco</option>
                <option value="Sombrero">Sombrero</option>
                <option value="Otro">Otro</option>
            </select>
            <input type="text" id="customTipo" placeholder="Especifica el tipo" style="display: none; color: black;">
            <button class="btn" id="addEventBtn">Agregar Evento</button>
            <button class="btn" id="saveEventBtn" style="display: none; background-color: #f44336;">¬°Hecho!</button>
            <button class="btn" id="cancelEditBtn" style="display: none; background-color: #f44336;">Desechar</button>
            <div id="save-status-message" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
            <div id="error-message" class="error-message"></div>
            <div id="missing-fields" class="error-message" style="margin-top: 10px;"></div>
            <div id="duplicate-warning" class="error-message" style="margin-top: 10px;"></div>
            <div id="success-message" class="success-message" style="margin-top: 10px; color: green; font-weight: bold;"></div>
            <input type="text" placeholder="Buscar eventos..." id="searchInput" style="display: none;">
            <select id="filterSelect">
                <option value="">Filtrar por/Quitar Filtro</option> <!-- Valor vac√≠o -->
                <option value="orquesta">Orquesta</option>
                <option value="municipio">Municipio</option>
                <option value="lugar">Lugar</option>
                <option value="todos">Mostrar todos los eventos</option>
                <option value="ultimoMesYMedio">Mostrar √∫ltimos 45 d√≠as</option>
                <option value="intervaloFechas">Intervalo de fechas</option>
            </select>
            <div id="dateRangeContainer" style="display: none;">
                <label for="startDate">Fecha de inicio:</label>
                <input type="date" id="startDate">
                <label for="endDate">Fecha de fin:</label>
                <input type="date" id="endDate">
            </div>
            <button class="btn" id="filterEventsBtn">Filtrar</button>
            <button class="btn" id="generateImageBtn">Generar Imagen</button>
            <a id="downloadLink" style="display: none;">Descargar Imagen</a>
            <br>
            <div style="margin-bottom: 20px;"></div>
        </div>
        <div class="events-container" id="events-container"></div>
    </div>
      <div class="calendar-container">
        <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=2&ctz=Atlantic%2FCanary&showPrint=0&showTitle=0&showNav=0&showDate=0&showTabs=0&showCalendars=0&showTz=0&mode=AGENDA&src=YXRydWppbWFyQGdtYWlsLmNvbQ&color=%23039BE5"
                frameborder="0"
                scrolling="auto"></iframe>
    </div>
    <canvas id="eventCanvas" width="1200" height="1200" style="display: none;"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCg1OiMDsmfoAGpSVYRnvWdl4tSPnLVoUo",
            authDomain: "debelingoconangel.firebaseapp.com",
            databaseURL: "https://debelingoconangel-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "debelingoconangel",
            storageBucket: "debelingoconangel.appspot.com",
            messagingSenderId: "690632293636",
            appId: "1:690632293636:web:5ccf13559fccf3d53a2451",
            measurementId: "G-T8BV0MLJQJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const eventsRef = ref(db, 'events');

        let events = [];
        let editingIndex = null;
        let selectedDate = null;

        let currentYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', () => {
            generateTimeOptions();
            createCalendars();
            setupCustomAutocomplete();  // Inicializar aqu√≠f
            document.getElementById('addEventBtn').addEventListener('click', addEvent);
            document.getElementById('filterEventsBtn').addEventListener('click', filterEvents);
            document.getElementById('saveEventBtn').addEventListener('click', function() {
                if (editingIndex) {
                    saveEvent(editingIndex);
                }
            });
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
            document.getElementById('filterSelect').addEventListener('change', toggleDateRangeInputs);
            document.getElementById('toggleButton').addEventListener('click', toggleCalendars);
            document.getElementById('tipo').addEventListener('change', toggleCustomTipo);
            document.getElementById('generateImageBtn').addEventListener('click', generateImage);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-section').style.display = 'block';
                    loadEvents();
                } else {
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('admin-section').style.display = 'none';
                }
            });
        });

        window.login = function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    if (user.uid === 'uid-del-usuario-permitido') {
                        document.getElementById('login-section').style.display = 'none';
                        document.getElementById('admin-section').style.display = 'block';
                        loadEvents();
                    } else {
                        document.getElementById('error-message').textContent = 'No tienes permiso para acceder a esta secci√≥n.';
                    }
                })
                .catch((error) => {
                    document.getElementById('error-message').textContent = 'Error al iniciar sesi√≥n: ' + error.message;
                });
        }

function updateOrquestaAutocomplete() {
    const allOrquestas = events.flatMap(e => e.orquesta.split(',').map(o => o.trim()));
    const uniqueOrquestas = [...new Set(allOrquestas)].sort();
    
    // Actualizar datalist existente
    const datalist = document.getElementById('orquesta-suggestions');
    datalist.innerHTML = '';
    uniqueOrquestas.forEach(orquesta => {
        const option = document.createElement('option');
        option.value = orquesta;
        datalist.appendChild(option);
    });
}
function setupCustomAutocomplete() {
    const input = document.getElementById('orquesta');
    let currentFocus = -1;

    input.addEventListener('input', function () {
        const val = this.value;
        const parts = val.split(',');
        const lastPart = parts[parts.length - 1].trim().toLowerCase();

        closeAllLists();

        if (!lastPart) return;

        const listContainer = document.createElement('div');
        listContainer.setAttribute('id', this.id + '-autocomplete-list');
        listContainer.setAttribute('class', 'autocomplete-items');
        this.parentNode.appendChild(listContainer);

        // Obtener sugerencias del datalist actualizado
        const options = document.getElementById('orquesta-suggestions').options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            if (option.value.toLowerCase().startsWith(lastPart)) {
                const item = document.createElement('div');
                item.innerHTML = "<strong>" + option.value.substr(0, lastPart.length) + "</strong>" + option.value.substr(lastPart.length);
                item.innerHTML += `<input type='hidden' value='${option.value}'>`;

                item.addEventListener('click', function () {
                    parts[parts.length - 1] = this.getElementsByTagName("input")[0].value;
                    input.value = parts.map(p => p.trim()).join(', ') + ', ';
                    closeAllLists();
                });

                listContainer.appendChild(item);
            }
        }
    });

    input.addEventListener('keydown', function (e) {
        let list = document.getElementById(this.id + '-autocomplete-list');
        if (list) list = list.getElementsByTagName('div');
        if (e.keyCode == 40) { // flecha abajo
            currentFocus++;
            addActive(list);
        } else if (e.keyCode == 38) { // flecha arriba
            currentFocus--;
            addActive(list);
        } else if (e.keyCode == 13) { // enter
            e.preventDefault();
            if (currentFocus > -1 && list) {
                list[currentFocus].click();
            }
        }
    });

    function addActive(list) {
        if (!list) return false;
        removeActive(list);
        if (currentFocus >= list.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = list.length - 1;
        list[currentFocus].classList.add("autocomplete-active");
    }

    function removeActive(list) {
        for (let i = 0; i < list.length; i++) {
            list[i].classList.remove("autocomplete-active");
        }
    }

    function closeAllLists(elmnt) {
        const items = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < items.length; i++) {
            if (elmnt != items[i] && elmnt != input) {
                items[i].parentNode.removeChild(items[i]);
            }
        }
    }

    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });
}

function getLugaresConMunicipio() {
    const lugares = events
        .filter(e => e.lugar && e.municipio) // asegurarse que haya ambos campos
        .map(e => ({
            lugar: e.lugar.trim(),
            municipio: e.municipio.trim()
        }));

    const uniquePairs = [];
    const seen = new Set();

    lugares.forEach(({ lugar, municipio }) => {
        const key = `${lugar.toLowerCase()}|${municipio.toLowerCase()}`;
        if (!seen.has(key)) {
            seen.add(key);
            uniquePairs.push({ lugar, municipio });
        }
    });

    return uniquePairs;
}

function setupLugarAutocomplete(lugaresList) {
    const input = document.getElementById('lugar');
    let currentFocus = -1;

    input.addEventListener('input', function () {
        const val = this.value.toLowerCase();
        closeAllLists();

        if (!val) return;

        const listContainer = document.createElement('div');
        listContainer.setAttribute('id', this.id + '-autocomplete-list');
        listContainer.setAttribute('class', 'autocomplete-items');
        document.body.appendChild(listContainer);
        const rect = input.getBoundingClientRect();
       listContainer.style.position = "absolute";
       listContainer.style.top = (rect.bottom + window.scrollY) + "px";
       listContainer.style.left = (rect.left + window.scrollX) + "px";
       listContainer.style.width = rect.width + "px";
        lugaresList.forEach(({ lugar, municipio }) => {
            const fullLabel = `${lugar} (${municipio})`;
            if (fullLabel.toLowerCase().includes(val)) {
                const item = document.createElement('div');
                item.innerHTML = `<strong>${lugar}</strong> (${municipio})`;
                item.innerHTML += `<input type="hidden" data-municipio="${municipio}" value="${lugar}">`;

                item.addEventListener('click', function () {
                    const selectedLugar = this.querySelector('input').value;
                    const selectedMunicipio = this.querySelector('input').dataset.municipio;

                    input.value = selectedLugar;

                    const municipioSelect = document.getElementById('municipio');
                    municipioSelect.value = selectedMunicipio;

                    closeAllLists();
                });

                listContainer.appendChild(item);
            }
        });
    });

    input.addEventListener('keydown', function (e) {
        let list = document.getElementById(this.id + '-autocomplete-list');
        if (list) list = list.getElementsByTagName('div');
        if (e.keyCode == 40) {
            currentFocus++;
            addActive(list);
        } else if (e.keyCode == 38) {
            currentFocus--;
            addActive(list);
        } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1 && list) list[currentFocus].click();
        }
    });

    function addActive(list) {
        if (!list) return false;
        removeActive(list);
        if (currentFocus >= list.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = list.length - 1;
        list[currentFocus].classList.add("autocomplete-active");
    }

    function removeActive(list) {
        for (let i = 0; i < list.length; i++) {
            list[i].classList.remove("autocomplete-active");
        }
    }

    function closeAllLists(elmnt) {
        const items = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < items.length; i++) {
            if (elmnt != items[i] && elmnt != input) {
                items[i].parentNode.removeChild(items[i]);
            }
        }
    }

    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });
}




function addEvent() {
    const eventDate = document.getElementById('eventDate').value;
    const orquesta = document.getElementById('orquesta').value.trim();
    const municipio = document.getElementById('municipio').value;
    const lugar = document.getElementById('lugar').value.trim();
    const hora = document.getElementById('hora').value;
    const tipo = document.getElementById('tipo').value;
    const customTipo = document.getElementById('customTipo').value.trim();
    const missingFields = document.getElementById('missing-fields');
    const duplicateWarning = document.getElementById('duplicate-warning');
    const addEventBtn = document.getElementById('addEventBtn');

    const missing = [];
    if (!eventDate) missing.push('Fecha');
    if (!orquesta) missing.push('Orquesta/Grupo');
    if (!municipio) missing.push('Municipio');
    if (!hora) missing.push('Hora de comienzo');
    if (!tipo && !customTipo) missing.push('Tipo de evento');
    if (tipo === "Otro" && !customTipo) missing.push('Especificaci√≥n del tipo');
    if (missing.length > 0) {
        missingFields.textContent = `Faltan los siguientes campos: ${missing.join(', ')}`;
        return;
    }

    const orquestas = orquesta
        .split(',')
        .map(o => o.trim())
        .filter(o => o.length > 0);

    const invalidOrquestas = orquestas.filter(o => o.charAt(0) !== o.charAt(0).toUpperCase());
    if (invalidOrquestas.length > 0) {
        alert('La primera letra de cada grupo/orquesta debe ser en may√∫scula.');
        return;
    }

    const existingOrquestas = events.flatMap(e => e.orquesta.split(',').map(o => o.trim()));
    const estandarizarNombre = o => o.charAt(0).toUpperCase() + o.slice(1);

    // ‚úÖ 1. Ya existe tal cual (evita alertas innecesarias)
    const yaExiste = orquestas.every(orq =>
        existingOrquestas.includes(estandarizarNombre(orq))
    );
    if (yaExiste) {
        saveNewEvent();
        return;
    }

    // ‚ö†Ô∏è 2. Existe con mismo nombre normalizado pero escritura distinta
    const conflictivas = orquestas.filter(orq => {
        const normalized = normalizeString(orq);
        return existingOrquestas.some(e => normalizeString(e) === normalized) &&
               !existingOrquestas.includes(orq);
    });

    if (conflictivas.length > 0) {
        alert(`‚ö†Ô∏è La orquesta "${conflictivas.join(', ')}" ya existe escrita de forma diferente. Revisa antes de continuar.`);
        return;
    }

    // ‚ö†Ô∏è 3. Muy similar (1 letra de diferencia)
    const similarBy1 = orquestas.filter(orq => {
        const estandarizada = estandarizarNombre(orq);
        if (existingOrquestas.includes(estandarizada)) return false;

        const normalized = normalizeString(orq);
        return existingOrquestas.some(existing =>
            levenshteinDistance(normalizeString(existing), normalized) === 1
        );
    });

    if (similarBy1.length > 0) {
        const confirmacion = confirm(`‚ö†Ô∏è El nombre de orquesta "${similarBy1.join(', ')}" es muy similar a uno ya existente (1 letra diferente). ¬øDeseas agregarlo igualmente?`);
        if (!confirmacion) return;
    }

    // üïí 4. Conflicto de horario con misma orquesta ¬±2h
    const sameDayEvents = events.filter(event =>
        orquestas.some(orq => normalizeString(event.orquesta).includes(normalizeString(orq))) &&
        event.day === eventDate
    );

    const eventoConflictivo = sameDayEvents.find(event => {
        const h1 = new Date(`1970-01-01T${event.hora}:00`).getTime();
        const h2 = new Date(`1970-01-01T${hora}:00`).getTime();
        return Math.abs(h1 - h2) <= 2 * 60 * 60 * 1000;
    });

    if (eventoConflictivo) {
        const orquestaConflicto = orquestas.find(orq =>
            normalizeString(eventoConflictivo.orquesta).includes(normalizeString(orq))
        );
        duplicateWarning.innerHTML = `
            ‚ö†Ô∏è La orquesta "${orquestaConflicto}" ya tiene evento el ${eventoConflictivo.day} a las ${eventoConflictivo.hora} en ${eventoConflictivo.lugar || 'casco'} (${eventoConflictivo.municipio}).
            ¬øDeseas agregarlo igualmente?
            <div><button class="btn" id="confirmYesBtn">S√≠</button><button class="btn" id="confirmNoBtn">No</button></div>
        `;
        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            duplicateWarning.textContent = '';
            saveNewEvent();
        });
        document.getElementById('confirmNoBtn').addEventListener('click', () => duplicateWarning.textContent = '');
        return;
    }

    // üïí 5. Conflicto por lugar y hora ¬±1h
    const conflictoLugar = events.find(event =>
        event.day === eventDate &&
        normalizeString(event.municipio) === normalizeString(municipio) &&
        normalizeString(event.lugar) === normalizeString(lugar) &&
        Math.abs(
            new Date(`1970-01-01T${event.hora}:00`).getTime() -
            new Date(`1970-01-01T${hora}:00`).getTime()
        ) <= 60 * 60 * 1000
    );

    if (conflictoLugar) {
        duplicateWarning.innerHTML = `
            ‚ö†Ô∏è Ya existe un evento el <b>${conflictoLugar.day}</b> en <b>${conflictoLugar.lugar || 'casco'}</b> (${conflictoLugar.municipio}) alrededor de la hora ${conflictoLugar.hora}, con otra orquesta.
            ¬øDeseas agregarlo igualmente?
            <div><button class="btn" id="confirmYesBtn">S√≠</button><button class="btn" id="confirmNoBtn">No</button></div>
        `;
        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            duplicateWarning.textContent = '';
            saveNewEvent();
        });
        document.getElementById('confirmNoBtn').addEventListener('click', () => duplicateWarning.textContent = '');
        return;
    }

    saveNewEvent();

    function saveNewEvent() {
        const event = {
            orquesta: orquestas.map(estandarizarNombre).join(', '),
            municipio,
            lugar,
            hora,
            day: eventDate,
            tipo: tipo === "Otro" ? customTipo : tipo,
            editing: false,
            cancelado: false,
            FechaAgregado: new Date().toISOString(),
            FechaEditado: new Date().toISOString()
        };

        addEventBtn.disabled = true;
        push(eventsRef, event).then(() => {
            clearForm();
            loadEvents();
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = '¬°Evento agregado con √©xito!';
            setTimeout(() => successMessage.textContent = '', 5000);
            addEventBtn.disabled = false;
        }).catch(error => {
            console.error('Error al agregar evento:', error);
            addEventBtn.disabled = false;
        });
    }
}


        function normalizeString(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function showSuccessMessage() {
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = '¬°Evento agregado con √©xito!';
            setTimeout(() => {
                successMessage.textContent = '';
            }, 2000);
        }

        function loadEvents() {
            return new Promise((resolve) => {
                onValue(eventsRef, (snapshot) => {
                    const loadedEvents = [];
                    const data = snapshot.val();
                    if (data) {
                        Object.entries(data).forEach(([key, value]) => {
                            loadedEvents.push({ id: key, ...value });
                        });
                    }
                    events = loadedEvents;
                    console.log('Eventos cargados:', events); // Registro de depuraci√≥n
                    renderEvents(events.filter(event => {
                        const eventDate = new Date(event.day);
                        const twoDaysAgo = new Date();
                        twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                        return eventDate >= twoDaysAgo;
                    }));
                  updateOrquestaAutocomplete();  // Solo actualiza la lista
                  const lugaresList = getLugaresConMunicipio();
                  setupLugarAutocomplete(lugaresList);
                  resolve();
                });
            });
        }

        function renderEvents(filteredEvents = []) {
            const eventsContainer = document.getElementById('events-container');
            eventsContainer.innerHTML = '';

            // Ordenar los eventos por fecha y hora de actuaci√≥n
            filteredEvents.sort((a, b) => {
                const dateA = new Date(`${a.day}T${a.hora}`);
                const dateB = new Date(`${b.day}T${b.hora}`);
                return dateA - dateB;
            });

            let currentMonthYear = '';

            filteredEvents.forEach((event) => {
                const eventDate = new Date(event.day);
                const monthYear = `${eventDate.getFullYear()}-${(eventDate.getMonth() + 1).toString().padStart(2, '0')}`;

                if (monthYear !== currentMonthYear) {
                    currentMonthYear = monthYear;
                    const monthDivider = document.createElement('div');
                    monthDivider.className = 'month-divider';
                    monthDivider.innerHTML = `<span>${new Date(event.day).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</span>`;
                    eventsContainer.appendChild(monthDivider);
                }

                const dayName = eventDate.toLocaleDateString('es-ES', { weekday: 'long' }).toLowerCase();
                const formattedEventDate = eventDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const eventDiv = document.createElement('div');
                eventDiv.className = `event ${event.editing ? 'editing' : ''} ${event.cancelado ? 'cancelado' : ''} ${dayName}`;
                eventDiv.setAttribute('data-id', event.id); // Add data-id attribute
                eventDiv.innerHTML = `
                    <span>${dayName.charAt(0).toUpperCase() + dayName.slice(1)} - ${formattedEventDate} - ${event.orquesta} - ${event.municipio} - ${event.lugar} - ${event.hora} - <b>${event.tipo}</b></span>
                    <div class="event-buttons">
                        <button class="btn-edit">Editar</button>
                        <button class="btn-delete">Eliminar</button>
                        ${event.editing ? '<a href="#form-container" class="btn-save">Guardar Cambios</a><button class="btn-cancel">Desechar</button>' : ''}
                        <p>Agregado: ${new Date(event.FechaAgregado).toLocaleDateString('es-ES')} | Editado: ${event.FechaEditado ? new Date(event.FechaEditado).toLocaleDateString('es-ES') : new Date(event.FechaAgregado).toLocaleDateString('es-ES')}</p>
                    </div>
                `;
                eventsContainer.appendChild(eventDiv);

                eventDiv.querySelector('.btn-edit').addEventListener('click', () => editEvent(event.id));
                eventDiv.querySelector('.btn-delete').addEventListener('click', () => deleteEvent(event.id));
                if (event.editing) {
                    const saveButton = eventDiv.querySelector('.btn-save');
                    if (saveButton) {
                        saveButton.addEventListener('click', () => saveEvent(event.id));
                    }
                    const cancelButton = eventDiv.querySelector('.btn-cancel');
                    if (cancelButton) {
                        cancelButton.addEventListener('click', cancelEdit);
                    }
                }
            });
        }

       function editEvent(id) {
    editingIndex = id;
    const eventRef = ref(db, `events/${id}`);

    onValue(eventRef, (snapshot) => {
        const eventData = snapshot.val();
        if (eventData) {
            // Mantener el filtro de 2 d√≠as al renderizar
            const filteredEvents = events.filter(event => {
                const eventDate = new Date(event.day);
                const twoDaysAgo = new Date();
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                return eventDate >= twoDaysAgo;
            });

            renderEvents(filteredEvents.map(e => e.id === id ? { ...e, editing: true } : e));

            // Rellenar el formulario con los datos del evento
            document.getElementById('orquesta').value = eventData.orquesta;
            document.getElementById('municipio').value = eventData.municipio;
            document.getElementById('lugar').value = eventData.lugar;
            document.getElementById('hora').value = eventData.hora;
            document.getElementById('eventDate').value = eventData.day;

            // Obtener opciones del select 'tipo'
            const tipoOptions = Array.from(document.getElementById('tipo').options).map(opt => opt.value);

            // Verificar si el tipo es personalizado (no est√° en las opciones)
            if (!tipoOptions.includes(eventData.tipo)) {
                document.getElementById('tipo').value = 'Otro';
                document.getElementById('customTipo').style.display = 'block';
                document.getElementById('customTipo').value = eventData.tipo;
            } else {
                document.getElementById('tipo').value = eventData.tipo;
                document.getElementById('customTipo').style.display = 'none';
                document.getElementById('customTipo').value = '';
            }

            // Mostrar los botones de guardar y cancelar
            document.getElementById('addEventBtn').style.display = 'none';
            document.getElementById('saveEventBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Limpiar el mensaje de advertencia
            document.getElementById('missing-fields').textContent = '';

            // Desplazarse al contenedor del formulario
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });

            // Asignar el evento despu√©s de agregar el bot√≥n al DOM
            const saveButton = document.querySelector(`.event[data-id="${id}"] .btn-save`);
            if (saveButton) {
                saveButton.addEventListener('click', () => saveEvent(id));
            }

            const cancelButton = document.querySelector(`.event[data-id="${id}"] .btn-cancel`);
            if (cancelButton) {
                cancelButton.addEventListener('click', cancelEdit);
            }
        }
    });
}

function levenshteinDistance(a, b) {
    const matrix = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));

    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;

    for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[i][j] = Math.min(
                matrix[i - 1][j] + 1,     // eliminaci√≥n
                matrix[i][j - 1] + 1,     // inserci√≥n
                matrix[i - 1][j - 1] + cost // sustituci√≥n
            );
        }
    }

    return matrix[a.length][b.length];
}













        function cancelEdit() {
            editingIndex = null;

            // Volver a aplicar el filtro de 2 d√≠as
            const filteredEvents = events.filter(event => {
                const eventDate = new Date(event.day);
                const twoDaysAgo = new Date();
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                return eventDate >= twoDaysAgo;
            });

            renderEvents(filteredEvents.map(e => ({ ...e, editing: false })));
            clearForm();

            document.getElementById('addEventBtn').style.display = 'inline-block';
            document.getElementById('saveEventBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

 function saveEvent(id) {
    if (!editingIndex) return;

    const eventRef = ref(db, `events/${id}`);

    get(eventRef).then((snapshot) => {
        const original = snapshot.val();
        const orquesta = document.getElementById('orquesta').value.trim();
        const municipio = document.getElementById('municipio').value.trim();
        const lugar = document.getElementById('lugar').value.trim();
        const hora = document.getElementById('hora').value;
        const eventDate = document.getElementById('eventDate').value;
        const tipo = document.getElementById('tipo').value;
        const customTipo = document.getElementById('customTipo').value.trim();
        const duplicateWarning = document.getElementById('duplicate-warning');

        const orquestas = orquesta
            .split(',')
            .map(o => o.trim())
            .filter(o => o.length > 0);

        const estandarizarNombre = o => o.charAt(0).toUpperCase() + o.slice(1);

        const invalidOrquestas = orquestas.filter(o => o.charAt(0) !== o.charAt(0).toUpperCase());
        if (invalidOrquestas.length > 0) {
            alert('La primera letra de cada grupo/orquesta debe ser en may√∫scula.');
            return;
        }

        const existingOrquestas = events
            .filter(e => e.id !== id)
            .flatMap(e => e.orquesta.split(',').map(o => o.trim()));

        // ‚úÖ 1. Ya existe tal cual
        const yaExiste = orquestas.every(orq =>
            existingOrquestas.includes(estandarizarNombre(orq))
        );
        if (yaExiste) {
            applyUpdate();
            return;
        }

        // ‚ö†Ô∏è 2. Escritura distinta pero normalizada igual
        const conflictivas = orquestas.filter(orq => {
            const normalized = normalizeString(orq);
            return existingOrquestas.some(e => normalizeString(e) === normalized) &&
                   !existingOrquestas.includes(orq);
        });

        if (conflictivas.length > 0) {
            alert(`‚ö†Ô∏è La orquesta "${conflictivas.join(', ')}" ya existe escrita de forma diferente. Revisa antes de guardar.`);
            return;
        }

        // ‚ö†Ô∏è 3. Similitud por 1 letra
        const similarBy1 = orquestas.filter(orq => {
            const estandarizada = estandarizarNombre(orq);
            if (existingOrquestas.includes(estandarizada)) return false;

            const normalized = normalizeString(orq);
            return existingOrquestas.some(existing =>
                levenshteinDistance(normalizeString(existing), normalized) === 1
            );
        });

        if (similarBy1.length > 0) {
            const confirmacion = confirm(`‚ö†Ô∏è El nombre de orquesta "${similarBy1.join(', ')}" es muy similar a uno ya existente (1 letra diferente). ¬øDeseas guardar el cambio igualmente?`);
            if (!confirmacion) return;
        }

        // üïí 4. Conflicto mismo d√≠a, misma orquesta ¬±2h
        const sameDayEvents = events.filter(ev =>
            ev.id !== id &&
            orquestas.some(orq => normalizeString(ev.orquesta).includes(normalizeString(orq))) &&
            ev.day === eventDate
        );

        const conflicto = sameDayEvents.find(ev => {
            const h1 = new Date(`1970-01-01T${ev.hora}:00`).getTime();
            const h2 = new Date(`1970-01-01T${hora}:00`).getTime();
            return Math.abs(h1 - h2) <= 2 * 60 * 60 * 1000;
        });

        if (conflicto) {
            const orquestaConflicto = orquestas.find(orq =>
                normalizeString(conflicto.orquesta).includes(normalizeString(orq))
            );
            duplicateWarning.innerHTML = `
                ‚ö†Ô∏è La orquesta "${orquestaConflicto}" ya tiene evento el ${conflicto.day} a las ${conflicto.hora} en ${conflicto.lugar || 'casco'} (${conflicto.municipio}).
                ¬øDeseas guardar este cambio igualmente?
                <div><button class="btn" id="confirmYesBtn">S√≠</button><button class="btn" id="confirmNoBtn">No</button></div>
            `;
            document.getElementById('confirmYesBtn').addEventListener('click', () => {
                duplicateWarning.textContent = '';
                applyUpdate();
            });
            document.getElementById('confirmNoBtn').addEventListener('click', () => duplicateWarning.textContent = '');
            return;
        }

        // üïí 5. Conflicto lugar + hora ¬±1h
        const conflictoLugar = events.find(ev =>
            ev.id !== id &&
            ev.day === eventDate &&
            normalizeString(ev.municipio) === normalizeString(municipio) &&
            normalizeString(ev.lugar) === normalizeString(lugar) &&
            Math.abs(
                new Date(`1970-01-01T${ev.hora}:00`).getTime() -
                new Date(`1970-01-01T${hora}:00`).getTime()
            ) <= 60 * 60 * 1000
        );

        if (conflictoLugar) {
            duplicateWarning.innerHTML = `
                ‚ö†Ô∏è Ya existe un evento el <b>${conflictoLugar.day}</b> en <b>${conflictoLugar.lugar || 'casco'}</b> (${conflictoLugar.municipio}) alrededor de la hora ${conflictoLugar.hora}, con otra orquesta.
                ¬øDeseas guardar este cambio igualmente?
                <div><button class="btn" id="confirmYesBtn">S√≠</button><button class="btn" id="confirmNoBtn">No</button></div>
            `;
            document.getElementById('confirmYesBtn').addEventListener('click', () => {
                duplicateWarning.textContent = '';
                applyUpdate();
            });
            document.getElementById('confirmNoBtn').addEventListener('click', () => duplicateWarning.textContent = '');
            return;
        }

        applyUpdate();

        function applyUpdate() {
            const updatedEvent = {
                orquesta: orquestas.map(estandarizarNombre).join(', '),
                municipio,
                lugar,
                hora,
                day: eventDate,
                tipo: tipo === "Otro" ? customTipo : tipo,
                editing: false,
                cancelado: false,
                FechaAgregado: original.FechaAgregado,
                FechaEditado: new Date().toISOString()
            };

            set(eventRef, updatedEvent).then(() => {
                editingIndex = null;
                loadEvents().then(() => {
                    clearForm();
                    document.getElementById('addEventBtn').style.display = 'inline-block';
                    document.getElementById('saveEventBtn').style.display = 'none';
                    document.getElementById('cancelEditBtn').style.display = 'none';
                });
            });
        }
    });
}


        function deleteEvent(id) {
            if (confirm("¬øEst√°s seguro de que quieres eliminar este evento?")) {
                const eventRef = ref(db, `events/${id}`);
                remove(eventRef).then(() => {
                    loadEvents();
                    console.log("Evento eliminado con √©xito.");
                }).catch((error) => {
                    console.error('Error al eliminar evento:', error);
                });
            }
        }

        function clearForm() {
            document.getElementById('orquesta').value = '';
            document.getElementById('municipio').value = '';
            document.getElementById('lugar').value = '';
            document.getElementById('hora').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('tipo').value = 'Baile Normal';
            document.getElementById('customTipo').value = '';
            document.getElementById('customTipo').style.display = 'none';
        }

        function generateTimeOptions() {
            const horaSelect = document.getElementById('hora');
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 15) {
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    horaSelect.appendChild(option);
                }
            }
            // Add the specific time option 23:59
            const specificTimeOption = document.createElement('option');
            specificTimeOption.value = '23:59';
            specificTimeOption.textContent = '23:59';
            horaSelect.appendChild(specificTimeOption);
        }

        function filterEvents() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const filterSelect = document.getElementById('filterSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Nuevo caso: cuando se selecciona la opci√≥n por defecto
            if (filterSelect === "") {
                loadEvents(); // Vuelve a cargar el filtro inicial de 2 d√≠as
                return;
            }

            if (filterSelect === 'todos') {
                // Mostrar todos los eventos sin filtrar
                renderEvents(events);
            } else if (filterSelect === 'ultimoMesYMedio') {
                // Mostrar eventos del √∫ltimo mes y medio
                const oneAndHalfMonthsAgo = new Date();
                oneAndHalfMonthsAgo.setMonth(oneAndHalfMonthsAgo.getMonth() - 1.5);
                const filteredEvents = events.filter(event => new Date(event.day) >= oneAndHalfMonthsAgo);
                renderEvents(filteredEvents);
            } else if (filterSelect === 'intervaloFechas') {
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const filteredEvents = events.filter(event => {
                        const eventDate = new Date(event.day);
                        return eventDate >= start && eventDate <= end;
                    });
                    renderEvents(filteredEvents);
                }
            } else if (filterSelect && searchInput) {
                const filteredEvents = events.filter(event => event[filterSelect].toLowerCase().includes(searchInput));
                renderEvents(filteredEvents);
            } else if (filterSelect === 'ultimoMesYMedio' && searchInput) {
                // Mostrar eventos del √∫ltimo mes y medio y filtrar por la palabra en todos los campos
                const oneAndHalfMonthsAgo = new Date();
                oneAndHalfMonthsAgo.setMonth(oneAndHalfMonthsAgo.getMonth() - 1.5);
                const filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.day);
                    return eventDate >= oneAndHalfMonthsAgo &&
                        (event.orquesta.toLowerCase().includes(searchInput) ||
                        event.municipio.toLowerCase().includes(searchInput) ||
                        event.lugar.toLowerCase().includes(searchInput) ||
                        event.tipo.toLowerCase().includes(searchInput));
                });
                renderEvents(filteredEvents);
            } else {
                // No hacer nada si no se selecciona ninguna opci√≥n de filtro
            }
        }

        function createCalendars() {
            const currentMonthCalendar = document.getElementById('currentMonthCalendar');
            const nextMonthCalendar = document.getElementById('nextMonthCalendar');
            const nextMonth2Calendar = document.getElementById('nextMonth2Calendar');
            const nextMonth3Calendar = document.getElementById('nextMonth3Calendar');
            const nextMonth4Calendar = document.getElementById('nextMonth4Calendar');

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const nextMonthDate = new Date(currentYear, currentMonth + 1, 1);
            const nextMonth = nextMonthDate.getMonth();
            const nextYear = nextMonthDate.getFullYear();

            const nextMonth2Date = new Date(currentYear, currentMonth + 2, 1);
            const nextMonth2 = nextMonth2Date.getMonth();
            const nextYear2 = nextMonth2Date.getFullYear();

            const nextMonth3Date = new Date(currentYear, currentMonth + 3, 1);
            const nextMonth3 = nextMonth3Date.getMonth();
            const nextYear3 = nextMonth3Date.getFullYear();

            const nextMonth4Date = new Date(currentYear, currentMonth + 4, 1);
            const nextMonth4 = nextMonth4Date.getMonth();
            const nextYear4 = nextMonth4Date.getFullYear();

            function generateCalendar(year, month, container) {
                const firstDay = (new Date(year, month)).getDay();
                const daysInMonth = 32 - new Date(year, month, 32).getDate();

                let date = 1;
                let html = '<tr>';

                for (let i = 0; i < 6; i++) {
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDay) {
                            html += '<td></td>';
                        } else if (date > daysInMonth) {
                            break;
                        } else {
                            const dayName = new Date(year, month, date).toLocaleDateString('es-ES', { weekday: 'long' }).toLowerCase();
                            html += `<td data-date="${year}-${(month + 1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}" class="${dayName}">${dayName.substring(0, 3)}<br>${date}</td>`;
                            date++;
                        }
                    }
                    if (date > daysInMonth) {
                        break;
                    }
                    html += '</tr><tr>';
                }
                html += '</tr>';

                container.querySelector('table').innerHTML = html;
                container.querySelector('.calendar-label h2').textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                container.querySelectorAll('td[data-date]').forEach(cell => {
                    cell.addEventListener('click', () => {
                        const selectedDate = cell.dataset.date;
                        document.getElementById('eventDate').value = selectedDate;
                        document.querySelectorAll('td[data-date]').forEach(c => c.classList.remove('selected'));
                        cell.classList.add('selected');

                        // Desplazarse al contenedor del formulario
                        document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }

            generateCalendar(currentYear, currentMonth, currentMonthCalendar);
            generateCalendar(nextYear, nextMonth, nextMonthCalendar);
            generateCalendar(nextYear2, nextMonth2, nextMonth2Calendar);
            generateCalendar(nextYear3, nextMonth3, nextMonth3Calendar);
            generateCalendar(nextYear4, nextMonth4, nextMonth4Calendar);
        }

        function scrollToEditingEvent() {
            if (editingIndex) {
                const editedEventElement = document.querySelector(`.event[data-id="${editingIndex}"]`);
                if (editedEventElement) {
                    editedEventElement.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }

        function toggleDateRangeInputs() {
            const filterSelect = document.getElementById('filterSelect').value;
            const dateRangeContainer = document.getElementById('dateRangeContainer');
            const eventDateLabel = document.getElementById('eventDateLabel');
            const searchInput = document.getElementById('searchInput');

            if (filterSelect === 'intervaloFechas' || filterSelect === 'ultimoMesYMedio' || filterSelect === 'todos') {
                eventDateLabel.style.display = 'none';
                document.getElementById('eventDate').style.display = 'none';
                searchInput.style.display = 'none';
            } else {
                eventDateLabel.style.display = 'block';
                document.getElementById('eventDate').style.display = 'block';
                searchInput.style.display = 'block';
            }

            if (filterSelect === 'intervaloFechas') {
                dateRangeContainer.style.display = 'block';
            } else {
                dateRangeContainer.style.display = 'none';
            }

            // Mostrar el campo de b√∫squeda solo si se selecciona una opci√≥n de filtrado espec√≠fica
            if (filterSelect === 'orquesta' || filterSelect === 'municipio' || filterSelect === 'lugar' || filterSelect === 'fecha') {
                searchInput.style.display = 'block';
            } else {
                searchInput.style.display = 'none';
            }
        }

        function toggleCalendars() {
            const toggleButton = document.getElementById('toggleButton');
            const nextMonth2Calendar = document.getElementById('nextMonth2Calendar');
            const nextMonth3Calendar = document.getElementById('nextMonth3Calendar');
            const nextMonth4Calendar = document.getElementById('nextMonth4Calendar');

            if (nextMonth2Calendar.style.display === 'none') {
                nextMonth2Calendar.style.display = 'block';
                nextMonth3Calendar.style.display = 'block';
                nextMonth4Calendar.style.display = 'block';
                toggleButton.textContent = 'Desplegar menos';
            } else {
                nextMonth2Calendar.style.display = 'none';
                nextMonth3Calendar.style.display = 'none';
                nextMonth4Calendar.style.display = 'none';
                toggleButton.textContent = 'Desplegar m√°s';
            }
        }

        function toggleCustomTipo() {
            const tipoSelect = document.getElementById('tipo').value;
            const customTipoInput = document.getElementById('customTipo');

            if (tipoSelect === 'Otro') {
                customTipoInput.style.display = 'block';
                customTipoInput.required = true; // A√±ade atributo required
            } else {
                customTipoInput.style.display = 'none';
                customTipoInput.value = '';
                customTipoInput.required = false; // Elimina required
            }
        }

/**
 * Genera una imagen en un canvas mostrando eventos filtrados por rango de fechas,
 * agrupados por d√≠a y ordenados por hora dentro de cada d√≠a.
 * Modificado para mostrar el lugar antes que el municipio.
 */
function generateImage() {
    // Obtener fechas de inicio y fin desde los campos de entrada
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    // Validar selecci√≥n de fechas
    if (!startDate || !endDate) {
        console.error('Por favor, selecciona un intervalo de fechas.');
        alert('Por favor, selecciona un intervalo de fechas.');
        return;
    }

    // Filtrar eventos basado en el rango de fechas seleccionado
    const filteredEvents = events.filter(event => {
        const eventDate = new Date(event.day + 'T00:00:00'); // A√±adir hora para evitar problemas de zona horaria
        const start = new Date(startDate + 'T00:00:00');
        const end = new Date(endDate + 'T23:59:59'); // Incluir el d√≠a final completo
        return eventDate >= start && eventDate <= end;
    });

    // Comprobar si se encontraron eventos
    if (filteredEvents.length === 0) {
        console.warn('No hay eventos en el intervalo seleccionado.');
        alert('No hay eventos en el intervalo seleccionado.');
        return;
    }

    // Agrupar eventos por fecha
    const groupedEvents = filteredEvents.reduce((acc, event) => {
        const date = event.day; // Asumiendo que event.day es 'YYYY-MM-DD'
        if (!acc[date]) acc[date] = [];
        acc[date].push(event);
        return acc;
    }, {});

    // Ordenar eventos dentro de cada d√≠a por hora ('hora')
    for (const date in groupedEvents) {
        groupedEvents[date].sort((a, b) => {
            const timeA = a.hora || '00:00';
            const timeB = b.hora || '00:00';
            return timeA.localeCompare(timeB);
        });
    }

    // Obtener las fechas ordenadas
    const sortedDates = Object.keys(groupedEvents).sort();

    // --- Configuraci√≥n del Canvas ---
    const maxWidth = 1200; // Ancho m√°ximo del canvas
    const colors = { // Esquema de colores para las diferentes partes del texto
        dia: '#5c4033',       // Marr√≥n oscuro para la fecha
        hora: '#00008b',       // Azul oscuro para la hora
        municipio: '#006400', // Verde oscuro para el municipio
        lugar: '#006400',     // Verde oscuro para el lugar (igual que municipio)
        tipo: '#9400d3',     // Violeta oscuro para el tipo
        texto: '#000000'        // Negro para el texto principal (orquesta)
    };
    const maxFontSize = 24; // Tama√±o m√°ximo de fuente permitido
    const minFontSize = 10; // Tama√±o m√≠nimo de fuente permitido
    const initialFontSize = Math.max(minFontSize, Math.min(maxFontSize, Math.floor(maxWidth / 25))); // Tama√±o inicial de fuente
    const lineHeightFactor = 1.2; // Factor para determinar la altura de l√≠nea
    const maxHeight = 1200; // Restricci√≥n de altura m√°xima para el canvas

    /**
     * Divide el texto en una subcadena que cabe dentro de maxWidth sin cortar palabras.
     * @param {string} text - El texto a ajustar.
     * @param {CanvasRenderingContext2D} ctx - El contexto de renderizado del canvas.
     * @param {number} maxWidth - El ancho m√°ximo permitido para la subcadena.
     * @returns {string} La subcadena que cabe, terminando en un espacio si es posible.
     */
    function getFittingSubstring(text, ctx, maxWidth) {
        let fitIndex = 0;
        let lastSpaceIndex = -1;
        let currentWidth = 0;

        for (let i = 0; i < text.length; i++) {
            if (text[i] === ' ') lastSpaceIndex = i;
            currentWidth = ctx.measureText(text.substring(0, i + 1)).width;

            if (currentWidth > maxWidth) {
                if (lastSpaceIndex !== -1 && lastSpaceIndex < i) {
                    return text.substring(0, lastSpaceIndex + 1);
                }
                return text.substring(0, i > 0 ? i : 0);
            }
            fitIndex = i + 1;
        }
        return text.substring(0, fitIndex);
    }

    /**
     * Calcula el n√∫mero de l√≠neas que ocupar√° una cadena de evento en el canvas.
     * @param {object} event - El objeto del evento.
     * @param {CanvasRenderingContext2D} ctx - El contexto de renderizado del canvas.
     * @param {number} maxWidth - El ancho m√°ximo para dibujar.
     * @returns {number} El n√∫mero total de l√≠neas requeridas para el evento.
     */
    function calculateEventLines(event, ctx, maxWidth) {
        let lines = 0;
        let currentLineWidth = 0;

        // --- CAMBIO: Orden de segmentos (lugar antes que municipio) ---
        const segments = [
            { text: event.orquesta || '', color: colors.texto },
            { text: event.lugar ? ` - ${event.lugar}` : '', color: colors.lugar }, // Lugar primero
            { text: event.municipio ? ` - ${event.municipio}` : '', color: colors.municipio }, // Municipio despu√©s
            { text: event.hora ? ` - ${event.hora}` : '', color: colors.hora },
            { text: event.tipo ? ` - ${event.tipo}` : '', color: colors.tipo }
        ];
        // -----------------------------------------------------------

        let isFirstSegmentOnLine = true;

        segments.forEach(({ text }) => {
            if (!text) return;

            let remainingText = text.trim();

            while (remainingText.length > 0) {
                const prefix = (currentLineWidth > 0 || !isFirstSegmentOnLine) ? ' ' : '';
                const effectiveText = prefix + remainingText;
                const availableWidth = maxWidth - currentLineWidth;
                let substring = getFittingSubstring(effectiveText, ctx, availableWidth);

                if (substring.length === 0 || (substring === prefix && remainingText.length > 0)) {
                    lines++;
                    currentLineWidth = 0;
                    isFirstSegmentOnLine = true;
                    continue;
                }

                 if (substring.startsWith(prefix)) {
                    substring = substring.substring(prefix.length);
                }

                currentLineWidth += ctx.measureText(prefix + substring).width;
                remainingText = remainingText.substring(substring.length).trimStart();

                 if (isFirstSegmentOnLine) {
                    lines++;
                    isFirstSegmentOnLine = false;
                }

                if (remainingText.length > 0) {
                    currentLineWidth = 0;
                    isFirstSegmentOnLine = true;
                }
            }
        });
        return Math.max(1, lines); // Asegurar al menos una l√≠nea por evento
    }

    /**
     * Formatea una cadena de fecha (YYYY-MM-DD) para incluir el nombre del d√≠a en may√∫sculas.
     * @param {string} dateStr - La cadena de fecha (YYYY-MM-DD).
     * @returns {string} Cadena de fecha formateada ej., "25/12/2024 (MI√âRCOLES)".
     */
    const formatDate = (dateStr) => {
        const date = new Date(dateStr + 'T12:00:00');
        const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' }).toUpperCase();
        const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
        return `${formattedDate} (${dayName})`;
    };

    // --- Calcular Altura del Canvas y Ajustar Tama√±o de Fuente ---
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.font = `bold ${initialFontSize}px Arial`;

    let requiredHeight = 0;
    const initialLineHeight = initialFontSize * lineHeightFactor;
    sortedDates.forEach((fecha) => {
        requiredHeight += initialLineHeight; // Altura para la cabecera de fecha
        groupedEvents[fecha].forEach(event => {
            const eventLines = calculateEventLines(event, tempCtx, maxWidth); // Usa la funci√≥n actualizada
            requiredHeight += initialLineHeight * eventLines; // Altura para este evento
        });
    });

    let fontSize = initialFontSize;
    let finalLineHeight = initialLineHeight;

    if (requiredHeight > maxHeight) {
        const scaleFactor = maxHeight / requiredHeight;
        fontSize = Math.max(minFontSize, Math.floor(initialFontSize * scaleFactor));
        finalLineHeight = fontSize * lineHeightFactor;

        tempCtx.font = `bold ${fontSize}px Arial`;
        requiredHeight = 0;
        sortedDates.forEach((fecha) => {
            requiredHeight += finalLineHeight;
            groupedEvents[fecha].forEach(event => {
                const eventLines = calculateEventLines(event, tempCtx, maxWidth); // Usa la funci√≥n actualizada
                requiredHeight += finalLineHeight * eventLines;
            });
        });
    }
    const canvasHeight = requiredHeight;

    // --- Configurar Canvas Real ---
    const canvas = document.getElementById('eventCanvas');
    if (!canvas) {
        console.error("Elemento Canvas con ID 'eventCanvas' no encontrado.");
        return;
    }
    canvas.width = maxWidth;
    canvas.height = canvasHeight;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.textBaseline = 'top';
    ctx.font = `bold ${fontSize}px Arial`;

    // --- Dibujar Contenido ---
    let currentY = 0;

    sortedDates.forEach((fecha, index) => {
        // --- Dibujar Cabecera de Fecha ---
        ctx.fillStyle = colors.dia;
        const dateText = formatDate(fecha);
        ctx.fillText(dateText, 0, currentY);

        if (index === 0) {
            const dateWidth = ctx.measureText(dateText).width;
            const generationDate = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const additionalText = ` - https://debelingoconangel.web.app - Generado ${generationDate}`;
            ctx.fillStyle = 'red';
            if (dateWidth + ctx.measureText(additionalText).width <= maxWidth) {
                 ctx.fillText(additionalText, dateWidth, currentY);
            } else {
                console.warn("El texto adicional podr√≠a desbordar el ancho del canvas.");
            }
        }

        // --- Dibujar Subrayado para Cabecera de Fecha ---
        ctx.strokeStyle = colors.dia;
        ctx.lineWidth = 1;
        const underlineMargin = 2;
        const lineY = currentY + fontSize + underlineMargin;
        ctx.beginPath();
        ctx.moveTo(0, lineY);
        ctx.lineTo(maxWidth, lineY);
        ctx.stroke();

        currentY += finalLineHeight;

        // --- Dibujar Eventos para la Fecha Actual (Ordenados por Hora) ---
        groupedEvents[fecha].forEach(event => {
            // --- CAMBIO: Orden de segmentos (lugar antes que municipio) ---
            const segments = [
                { text: event.orquesta || '', color: colors.texto },
                { text: event.lugar ? ` - ${event.lugar}` : '', color: colors.lugar }, // Lugar primero
                { text: event.municipio ? ` - ${event.municipio}` : '', color: colors.municipio }, // Municipio despu√©s
                { text: event.hora ? ` - ${event.hora}` : '', color: colors.hora },
                { text: event.tipo ? ` - ${event.tipo}` : '', color: colors.tipo }
            ];
            // -----------------------------------------------------------

            let currentX = 0;
            // let lineStartY = currentY; // No es necesario si actualizamos currentY directamente

            segments.forEach(({ text, color }) => {
                if (!text) return;

                ctx.fillStyle = color;
                let remainingText = text.trim();

                while (remainingText.length > 0) {
                    const availableWidth = maxWidth - currentX;
                    let substring = getFittingSubstring(remainingText, ctx, availableWidth);

                     if (substring === '' && currentX === 0 && ctx.measureText(remainingText.split(' ')[0]).width > maxWidth) {
                        let breakIndex = 0;
                        for(let k=1; k <= remainingText.length; k++){
                            if(ctx.measureText(remainingText.substring(0, k)).width > maxWidth){
                                breakIndex = k-1;
                                break;
                            }
                            breakIndex = k;
                        }
                        substring = remainingText.substring(0, breakIndex);
                        if(substring === '') substring = remainingText[0];
                    }
                    else if (substring === '') {
                        currentY += finalLineHeight;
                        currentX = 0;
                        continue;
                    }

                    ctx.fillText(substring, currentX, currentY);
                    currentX += ctx.measureText(substring).width;
                    remainingText = remainingText.substring(substring.length).trimStart();

                    if (remainingText.length > 0) {
                        currentY += finalLineHeight;
                        currentX = 0;
                    }
                }
            });
            // Mover Y al inicio de la siguiente l√≠nea de evento despu√©s de dibujar todos los segmentos
            currentY += finalLineHeight;
        });
    });

    // --- Proporcionar Enlace de Descarga ---
    try {
        const dataURL = canvas.toDataURL('image/png');
        const downloadLink = document.getElementById('downloadLink');
        if (downloadLink) {
            downloadLink.href = dataURL;
            downloadLink.style.display = 'inline-block';
            downloadLink.download = 'eventos.png';
        } else {
            console.error("Elemento de enlace de descarga con ID 'downloadLink' no encontrado.");
        }
    } catch (e) {
        console.error("Error generando data URL:", e);
        alert("Error al generar la imagen. Puede deberse a restricciones de seguridad del navegador.");
    }
}

</script>
</body>
</html>

